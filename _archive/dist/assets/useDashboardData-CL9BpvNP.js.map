{"version":3,"file":"useDashboardData-CL9BpvNP.js","sources":["../../src/hooks/useDashboardData.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { supabase } from '../lib/supabase';\nimport productionDataService from '../services/productionDataService';\n\n/**\n * Hook unifiÃ© pour rÃ©cupÃ©rer les donnÃ©es depuis Supabase uniquement\n */\nexport const useDashboardData = (schoolContext = null) => {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [data, setData] = useState({\n    metrics: [],\n    classAverages: [],\n    attendance: [],\n    payments: [],\n    personnel: [],\n    students: [],\n    schoolStats: {},\n    schoolDetails: null,\n    classes: []\n  });\n  const [dataLoading, setDataLoading] = useState({\n    metrics: false,\n    classAverages: false,\n    attendance: false,\n    payments: false,\n    personnel: false,\n    students: false,\n    schoolStats: false,\n    schoolDetails: false,\n    classes: false\n  });\n  const [errors, setErrors] = useState({});\n\n  // RÃ©cupÃ©rer l'utilisateur connectÃ© au montage\n  useEffect(() => {\n    const getUser = async () => {\n      try {\n        const { data: { user: authUser }, error } = await supabase.auth.getUser();\n        if (error) throw error;\n        setUser(authUser);\n      } catch (error) {\n        console.error('Erreur rÃ©cupÃ©ration utilisateur:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n    getUser();\n  }, []);\n\n  // Fonction gÃ©nÃ©rique pour charger des donnÃ©es\n  const loadData = async (key, serviceMethod, ...args) => {\n    if (loading) return; // Attendre que l'utilisateur soit chargÃ©\n\n    setDataLoading(prev => ({ ...prev, [key]: true }));\n    setErrors(prev => ({ ...prev, [key]: null }));\n\n    try {\n      // Initialiser le contexte de sÃ©curitÃ©\n      if (productionDataService.setUserContext) {\n        let userId, schoolId;\n\n        // PrioritÃ© 1: DonnÃ©es de l'Ã©cole depuis le contexte passÃ© en paramÃ¨tre\n        if (schoolContext?.director_user_id && schoolContext?.id) {\n          userId = schoolContext.director_user_id;\n          schoolId = schoolContext.id;\n        }\n        // PrioritÃ© 2: DonnÃ©es de l'utilisateur\n        else if (user?.id) {\n          userId = user.id;\n          // RÃ©cupÃ©rer school_id depuis la table users\n          const { data: dbUser } = await supabase\n            .from('users')\n            .select('school_id')\n            .eq('id', user.id)\n            .single();\n          schoolId = dbUser?.school_id;\n        }\n\n        if (userId && schoolId) {\n          console.log(`ðŸ” Initialisation contexte sÃ©curisÃ©: User=${userId}, School=${schoolId}`);\n          productionDataService.setUserContext(userId, schoolId);\n        } else {\n          console.warn('âš ï¸ Impossible d\\'initialiser le contexte sÃ©curisÃ©');\n          console.warn('  - userId:', userId);\n          console.warn('  - schoolId:', schoolId);\n        }\n      }\n\n      // Passer l'ID de l'Ã©cole comme premier argument si disponible\n      const schoolId = schoolContext?.id || null;\n      const finalArgs = schoolId ? [schoolId, ...args] : args;\n\n      const result = await productionDataService[serviceMethod](...finalArgs);\n\n      if (result.error) {\n        throw result.error;\n      }\n\n      setData(prev => ({ ...prev, [key]: result.data }));\n    } catch (error) {\n      console.error(`Erreur lors du chargement de ${key}:`, error);\n      setErrors(prev => ({ ...prev, [key]: error }));\n    } finally {\n      setDataLoading(prev => ({ ...prev, [key]: false }));\n    }\n  };\n\n  // MÃ©thodes publiques pour charger diffÃ©rents types de donnÃ©es\n  const loadMetrics = () => loadData('metrics', 'getDashboardMetrics');\n\n  const loadClassAverages = (filters = {}) =>\n    loadData('classAverages', 'getClassAverages', filters);\n\n  const loadAttendance = (period = 'week') =>\n    loadData('attendance', 'getAttendanceData', period);\n\n  const loadPayments = () => loadData('payments', 'getPaymentData');\n\n  const loadPersonnel = () => loadData('personnel', 'getPersonnel');\n\n  const loadStudents = (filters = {}) =>\n    loadData('students', 'getStudents', filters);\n\n  const loadSchoolStats = () => loadData('schoolStats', 'getSchoolStats');\n\n  const loadSchoolDetails = () => {\n    const userId = user?.id;\n    return loadData('schoolDetails', 'getSchoolDetails', null, userId);\n  };\n\n  const loadClasses = () => loadData('classes', 'getClasses');\n\n  // Charger toutes les donnÃ©es de base\n  const loadAllData = () => {\n    loadMetrics();\n    loadClassAverages();\n    loadAttendance();\n    loadPayments();\n    loadPersonnel();\n    loadSchoolStats();\n    loadSchoolDetails();\n    loadClasses();\n  };\n\n  // Charger les donnÃ©es au montage une fois l'utilisateur chargÃ©\n  useEffect(() => {\n    if (!loading && user) {\n      console.log(`ðŸš€ Chargement des donnÃ©es depuis Supabase`);\n\n      // DonnÃ©es critiques en prioritÃ©\n      Promise.all([\n        loadSchoolDetails(),\n        loadMetrics()\n      ]).then(() => {\n        // Charger le reste en parallÃ¨le\n        Promise.all([\n          loadSchoolStats(),\n          loadClasses(),\n          loadPersonnel(),\n          loadClassAverages(),\n          loadAttendance(),\n          loadPayments()\n        ]);\n      });\n    }\n  }, [loading, user]);\n\n  return {\n    // Ã‰tat des donnÃ©es\n    data,\n    loading: dataLoading,\n    errors,\n\n    // Utilisateur\n    user,\n    userLoading: loading,\n\n    // MÃ©thodes de chargement\n    loadMetrics,\n    loadClassAverages,\n    loadAttendance,\n    loadPayments,\n    loadPersonnel,\n    loadStudents,\n    loadSchoolStats,\n    loadSchoolDetails,\n    loadClasses,\n    loadAllData,\n\n    // Fonction utilitaire pour rafraÃ®chir toutes les donnÃ©es\n    refresh: loadAllData,\n\n    // VÃ©rifier si des donnÃ©es sont en cours de chargement\n    isAnyLoading: Object.values(dataLoading).some(Boolean),\n\n    // VÃ©rifier s'il y a des erreurs\n    hasErrors: Object.values(errors).some(Boolean),\n\n    // Obtenir toutes les erreurs\n    allErrors: Object.entries(errors)\n      .filter(([_, error]) => error)\n      .map(([key, error]) => ({ key, error }))\n  };\n};\n\nexport default useDashboardData;\n"],"names":["useDashboardData","schoolContext","user","setUser","useState","loading","setLoading","data","setData","dataLoading","setDataLoading","errors","setErrors","useEffect","authUser","error","supabase","loadData","key","serviceMethod","args","prev","productionDataService","userId","schoolId","dbUser","finalArgs","result","loadMetrics","loadClassAverages","filters","loadAttendance","period","loadPayments","loadPersonnel","loadStudents","loadSchoolStats","loadSchoolDetails","loadClasses","loadAllData","_"],"mappings":"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"}