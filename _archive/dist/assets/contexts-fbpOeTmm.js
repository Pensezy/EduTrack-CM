import{a as R,r as h}from"./react-vendor-CFDIsUAY.js";import{s as p,d as P}from"./services-CdXttHtG.js";var N={exports:{}},E={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var O;function A(){if(O)return E;O=1;var S=R(),x=Symbol.for("react.element"),i=Symbol.for("react.fragment"),U=Object.prototype.hasOwnProperty,u=S.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,D={key:!0,ref:!0,__self:!0,__source:!0};function g(w,a,_){var d,I={},v=null,s=null;_!==void 0&&(v=""+_),a.key!==void 0&&(v=""+a.key),a.ref!==void 0&&(s=a.ref);for(d in a)U.call(a,d)&&!D.hasOwnProperty(d)&&(I[d]=a[d]);if(w&&w.defaultProps)for(d in a=w.defaultProps,a)I[d]===void 0&&(I[d]=a[d]);return{$$typeof:x,type:w,key:v,ref:s,props:I,_owner:u.current}}return E.Fragment=i,E.jsx=g,E.jsxs=g,E}var b;function C(){return b||(b=1,N.exports=A()),N.exports}var J=C();const k=h.createContext({}),L=()=>{const S=h.useContext(k);if(!S)throw new Error("useAuth must be used within an AuthProvider");return S},T=({children:S})=>{const[x,i]=h.useState(null),[U,u]=h.useState(null),[D,g]=h.useState(!0),[w,a]=h.useState(null);h.useEffect(()=>{(async()=>{try{console.log("üîç V√©rification de la session Supabase...");const{data:{session:e},error:r}=await p.auth.getSession();if(e!=null&&e.user){console.log("‚úÖ Session Supabase trouv√©e:",e.user.email),await _(e.user),i(e.user),u(e.user),localStorage.setItem("edutrack-user",JSON.stringify(e.user)),g(!1);return}console.log("‚ÑπÔ∏è Pas de session Supabase, v√©rification localStorage...");const f=localStorage.getItem("edutrack-user");if(f){const l=JSON.parse(f);console.log("üîÑ Utilisateur depuis localStorage:",l.email),l.sessionId?(console.log("‚úÖ Compte local d√©tect√©, utilisation directe des donn√©es"),i(l),u(l),g(!1)):(console.warn("‚ö†Ô∏è Donn√©es localStorage invalides"),localStorage.removeItem("edutrack-user"),g(!1))}else console.log("‚ÑπÔ∏è Aucune session trouv√©e"),g(!1)}catch(e){console.error("‚ùå Erreur lors de l'initialisation:",e),localStorage.removeItem("edutrack-user"),g(!1)}})();let c=!1,o=null;const{data:y}=p.auth.onAuthStateChange(async(e,r)=>{var f;if(console.log("üîê Changement d'√©tat Supabase:",e,(f=r==null?void 0:r.user)==null?void 0:f.email),e!=="SIGNED_IN"&&e!=="SIGNED_OUT"&&e!=="INITIAL_SESSION"){console.log("‚è≠Ô∏è √âv√©nement ignor√© (type non g√©r√©):",e);return}if(c){console.log("‚è≠Ô∏è √âv√©nement ignor√© (traitement en cours)");return}if((e==="SIGNED_IN"||e==="INITIAL_SESSION")&&(r!=null&&r.user)){if(o===r.user.id){console.log("‚úÖ Utilisateur d√©j√† trait√©, ignorer l'√©v√©nement");return}const l=localStorage.getItem("edutrack-user");if(l)try{if(JSON.parse(l).id===r.user.id){console.log("‚úÖ Utilisateur d√©j√† d√©fini dans localStorage, ignorer"),o=r.user.id;return}}catch{}c=!0;try{await _(r.user),i(r.user),u(r.user),localStorage.setItem("edutrack-user",JSON.stringify(r.user)),o=r.user.id,console.log("‚úÖ Utilisateur configur√© avec succ√®s")}finally{c=!1}}else if(e==="SIGNED_OUT"){console.log("üëã D√©connexion Supabase"),o=null;const l=localStorage.getItem("edutrack-user");if(l)try{JSON.parse(l).sessionId||(localStorage.removeItem("edutrack-user"),i(null),u(null))}catch(m){console.error("Erreur parsing user:",m)}}}),t=e=>{if(e.key==="edutrack-user")if(console.log("üîÑ Changement de compte d√©tect√© dans localStorage (autre fen√™tre)"),e.newValue)try{const r=JSON.parse(e.newValue);console.log("üë§ Nouveau compte:",r.email),i(r),u(r)}catch(r){console.error("Erreur parsing nouveau user:",r)}else i(null),u(null)},n=e=>{console.log("üîÑ Changement de compte d√©tect√© (√©v√©nement personnalis√©)");const r=e.detail;r?(console.log("üë§ Nouveau compte:",r.email),i(r),u(r)):(i(null),u(null))};return window.addEventListener("storage",t),window.addEventListener("edutrack-user-changed",n),()=>{var e;(e=y==null?void 0:y.subscription)==null||e.unsubscribe(),window.removeEventListener("storage",t),window.removeEventListener("edutrack-user-changed",n)}},[]);const _=async s=>{try{const{data:c,error:o}=await p.from("users").select("*").eq("id",s.id).single();return c&&!o?(console.log("‚úÖ User already exists in database:",c.email),c):(console.log("‚ÑπÔ∏è User not found in database, will be created by trigger"),null)}catch(c){return console.warn("‚ö†Ô∏è Exception checking user in database:",c),null}},v={user:x,userProfile:U,loading:D,signInWithPin:async(s,c)=>{try{if(a(null),!c||!s)throw new Error("Identifiant et code PIN requis");const{data:o,error:y}=await p.rpc("verify_pin",{identifier:c,pin_input:s});if(y||!o||o.length===0)throw new Error("Identifiant ou code PIN incorrect");const t={id:o[0].user_id,full_name:o[0].user_full_name,role:o[0].user_role,phone:o[0].user_phone,email:o[0].user_email};try{const{data:n,error:e}=await p.from("users").select("id").eq("email",t.email).single();if(e&&console.warn("‚ö†Ô∏è No existing users row found by email (or select error):",(e==null?void 0:e.message)||e),n&&n.id)t.id=n.id;else{const f=(typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():null)||`gen-${Date.now()}-${Math.floor(Math.random()*1e3)}`,{data:l,error:m}=await p.from("users").upsert({id:f,email:t.email,full_name:t.full_name||t.email.split("@")[0],role:t.role||"student",phone:t.phone||"",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();m?console.warn("‚ö†Ô∏è Could not create users row with generated UUID:",m):l&&l.id?t.id=l.id:console.warn("‚ö†Ô∏è No id returned after upsert; keeping original id:",t.id)}}catch(n){console.warn("‚ö†Ô∏è Exception while resolving user id for sign-in:",n)}if(await _(t),t.role==="principal")try{const n=await P.validateDirectorData(t.id,t.email);n.corrections&&n.corrections.length>0&&console.log("‚úÖ Donn√©es corrig√©es lors de la connexion:",n.corrections),n.schoolData&&n.schoolData.director_name&&(t.full_name=n.schoolData.director_name)}catch(n){console.warn("‚ö†Ô∏è Erreur validation donn√©es:",n)}return localStorage.setItem("edutrack-user",JSON.stringify(t)),i(t),u(t),{user:t,error:null}}catch(o){return console.error("Erreur de connexion:",o),a((o==null?void 0:o.message)||"Erreur de connexion"),{user:null,error:o}}},signOut:async()=>{try{localStorage.removeItem("edutrack-user"),localStorage.removeItem("edutrack-session"),i(null),u(null),a(null);const{error:s}=await p.auth.signOut();if(s)throw s}catch(s){console.error("Erreur lors de la d√©connexion:",s),a(s==null?void 0:s.message)}},error:w,setError:a};return J.jsx(k.Provider,{value:v,children:S})};export{T as A,J as j,L as u};
//# sourceMappingURL=contexts-fbpOeTmm.js.map
