import{s as f}from"./services-CdXttHtG.js";import{E as C}from"./pdf-vendor-wz8qypYI.js";class Y{constructor(){this.pageWidth=210,this.pageHeight=297,this.margin=20}formatDate(e){if(!e)return"__/__/____";try{const t=new Date(e);return isNaN(t.getTime())?"__/__/____":t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}catch{return"__/__/____"}}getBirthDate(e){return(e==null?void 0:e.date_of_birth)||(e==null?void 0:e.birth_date)||(e==null?void 0:e.birthdate)||(e==null?void 0:e.dateOfBirth)}generateCertificatScolarite(e){var _;const{student:t,school:n,academicYear:a}=e,r=new C;r.setFontSize(16),r.setFont("helvetica","bold"),r.text((n==null?void 0:n.name)||"√âcole",this.pageWidth/2,30,{align:"center"}),r.setFontSize(10),r.setFont("helvetica","normal"),r.text((n==null?void 0:n.address)||"",this.pageWidth/2,38,{align:"center"}),r.text(`${(n==null?void 0:n.city)||""}, ${(n==null?void 0:n.country)||"Cameroun"}`,this.pageWidth/2,44,{align:"center"}),r.setLineWidth(.5),r.line(this.margin,52,this.pageWidth-this.margin,52),r.setFontSize(18),r.setFont("helvetica","bold"),r.text("CERTIFICAT DE SCOLARIT√â",this.pageWidth/2,70,{align:"center"}),r.setFontSize(12),r.setFont("helvetica","normal"),r.text(`Ann√©e scolaire ${a||new Date().getFullYear()+"-"+(new Date().getFullYear()+1)}`,this.pageWidth/2,80,{align:"center"}),r.setFontSize(12);const i=100,s=10;r.text("Je soussign√©(e), Directeur(trice) de l'√©tablissement scolaire mentionn√© ci-dessus,",this.margin,i),r.text("certifie que :",this.margin,i+s),r.setFont("helvetica","bold");const o=`${(t==null?void 0:t.last_name)||""} ${(t==null?void 0:t.first_name)||""}`.trim()||"Nom de l'√©l√®ve";r.text(`L'√©l√®ve : ${o}`,this.margin,i+s*3),r.setFont("helvetica","normal");const l=this.formatDate(this.getBirthDate(t));r.text(`N√©(e) le : ${l}`,this.margin,i+s*4),r.text(`Lieu de naissance : ${(t==null?void 0:t.birth_place)||(t==null?void 0:t.place_of_birth)||"________"}`,this.margin+80,i+s*4),r.text(`Classe : ${(t==null?void 0:t.class_name)||"________"}`,this.margin,i+s*5),r.text(`Matricule : ${(t==null?void 0:t.matricule)||((_=t==null?void 0:t.id)==null?void 0:_.substring(0,8))||"________"}`,this.margin,i+s*6),r.text("Est r√©guli√®rement inscrit(e) dans notre √©tablissement pour l'ann√©e scolaire en cours.",this.margin,i+s*8),r.text("Ce certificat est d√©livr√© √† l'int√©ress√©(e) pour servir et valoir ce que de droit.",this.margin,i+s*10);const c=new Date().toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"});return r.text(`Fait √† ${(n==null?void 0:n.city)||"________"}, le ${c}`,this.pageWidth-this.margin-60,i+s*13),r.setFont("helvetica","bold"),r.text("Le(La) Directeur(trice)",this.pageWidth-this.margin-40,i+s*16),r.setDrawColor(150,150,150),r.setLineWidth(.3),r.rect(this.margin,i+s*14,40,25),r.setFontSize(8),r.setFont("helvetica","normal"),r.text("Cachet de l'√©cole",this.margin+5,i+s*16),r}generateCertificatFrequentation(e){const{student:t,school:n,academicYear:a}=e,r=new C;r.setFontSize(16),r.setFont("helvetica","bold"),r.text((n==null?void 0:n.name)||"√âcole",this.pageWidth/2,30,{align:"center"}),r.setFontSize(10),r.setFont("helvetica","normal"),r.text((n==null?void 0:n.address)||"",this.pageWidth/2,38,{align:"center"}),r.setFontSize(18),r.setFont("helvetica","bold"),r.text("CERTIFICAT DE FR√âQUENTATION",this.pageWidth/2,70,{align:"center"}),r.setFontSize(12),r.setFont("helvetica","normal");const i=100,s=10;r.text("Je soussign√©(e), Directeur(trice) de l'√©tablissement scolaire,",this.margin,i),r.text("atteste que l'√©l√®ve :",this.margin,i+s*2),r.setFont("helvetica","bold");const o=`${(t==null?void 0:t.last_name)||""} ${(t==null?void 0:t.first_name)||""}`.trim();r.text(o||"Nom de l'√©l√®ve",this.margin,i+s*3),r.setFont("helvetica","normal"),r.text(`Inscrit(e) en classe de : ${(t==null?void 0:t.class_name)||"________"}`,this.margin,i+s*5),r.text("Fr√©quente r√©guli√®rement et assid√ªment notre √©tablissement.",this.margin,i+s*7),r.text("En foi de quoi, le pr√©sent certificat lui est d√©livr√© pour servir et",this.margin,i+s*9),r.text("valoir ce que de droit.",this.margin,i+s*10);const l=new Date().toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"});return r.text(`Fait √† ${(n==null?void 0:n.city)||"________"}, le ${l}`,this.pageWidth-this.margin-60,i+s*13),r.setFont("helvetica","bold"),r.text("Le(La) Directeur(trice)",this.pageWidth-this.margin-40,i+s*16),r}generateFicheInscription(e){var o;const{student:t,school:n,academicYear:a}=e,r=new C;r.setFontSize(16),r.setFont("helvetica","bold"),r.text((n==null?void 0:n.name)||"√âcole",this.pageWidth/2,25,{align:"center"}),r.setFontSize(14),r.text("FICHE D'INSCRIPTION",this.pageWidth/2,45,{align:"center"}),r.text(`Ann√©e scolaire ${a||"____-____"}`,this.pageWidth/2,53,{align:"center"}),r.setFontSize(12),r.setFont("helvetica","bold"),r.text("INFORMATIONS DE L'√âL√àVE",this.margin,70),r.setLineWidth(.3),r.line(this.margin,73,this.pageWidth-this.margin,73),r.setFont("helvetica","normal"),r.setFontSize(11);const i=82,s=8;return r.text(`Nom : ${(t==null?void 0:t.last_name)||"________________________"}`,this.margin,i),r.text(`Pr√©nom : ${(t==null?void 0:t.first_name)||"________________________"}`,this.pageWidth/2,i),r.text(`Date de naissance : ${this.formatDate(this.getBirthDate(t))}`,this.margin,i+s),r.text(`Lieu de naissance : ${(t==null?void 0:t.place_of_birth)||(t==null?void 0:t.birth_place)||"________________"}`,this.pageWidth/2,i+s),r.text(`Sexe : ${(t==null?void 0:t.gender)==="M"?"Masculin":(t==null?void 0:t.gender)==="F"?"F√©minin":"________"}`,this.margin,i+s*2),r.text(`Nationalit√© : ${(t==null?void 0:t.nationality)||"Camerounaise"}`,this.pageWidth/2,i+s*2),r.text(`Classe : ${(t==null?void 0:t.class_name)||"________"}`,this.margin,i+s*3),r.text(`Matricule : ${(t==null?void 0:t.matricule)||((o=t==null?void 0:t.id)==null?void 0:o.substring(0,8))||"________"}`,this.pageWidth/2,i+s*3),r.setFont("helvetica","bold"),r.text("INFORMATIONS DU PARENT/TUTEUR",this.margin,i+s*5),r.line(this.margin,i+s*5+3,this.pageWidth-this.margin,i+s*5+3),r.setFont("helvetica","normal"),r.text(`Nom du p√®re/tuteur : ${(t==null?void 0:t.father_name)||"________________________"}`,this.margin,i+s*6.5),r.text(`Profession : ${(t==null?void 0:t.father_profession)||"________________"}`,this.pageWidth/2,i+s*6.5),r.text(`Nom de la m√®re : ${(t==null?void 0:t.mother_name)||"________________________"}`,this.margin,i+s*7.5),r.text(`Profession : ${(t==null?void 0:t.mother_profession)||"________________"}`,this.pageWidth/2,i+s*7.5),r.text(`T√©l√©phone : ${(t==null?void 0:t.parent_phone)||"________________"}`,this.margin,i+s*8.5),r.text(`Email : ${(t==null?void 0:t.parent_email)||"________________________"}`,this.pageWidth/2,i+s*8.5),r.text(`Adresse : ${(t==null?void 0:t.address)||"________________________________________"}`,this.margin,i+s*9.5),r.setFont("helvetica","bold"),r.text("Signature du parent/tuteur",this.margin,i+s*13),r.text("Cachet et signature de l'√©cole",this.pageWidth-this.margin-50,i+s*13),r.setDrawColor(150,150,150),r.rect(this.margin,i+s*14,60,25),r.rect(this.pageWidth-this.margin-60,i+s*14,60,25),r}generateAttestationPaiement(e){const{student:t,school:n,academicYear:a,amount:r,paymentDate:i}=e,s=new C;s.setFontSize(16),s.setFont("helvetica","bold"),s.text((n==null?void 0:n.name)||"√âcole",this.pageWidth/2,30,{align:"center"}),s.setFontSize(18),s.text("ATTESTATION DE PAIEMENT",this.pageWidth/2,60,{align:"center"}),s.setFontSize(12),s.setFont("helvetica","normal");const o=90,l=10;s.text("Je soussign√©(e), responsable administratif de l'√©tablissement,",this.margin,o),s.text("atteste avoir re√ßu de :",this.margin,o+l*2),s.setFont("helvetica","bold");const c=`${(t==null?void 0:t.last_name)||""} ${(t==null?void 0:t.first_name)||""}`.trim();s.text(`Parent/Tuteur de : ${c||"________________________"}`,this.margin,o+l*3),s.setFont("helvetica","normal"),s.text(`Classe : ${(t==null?void 0:t.class_name)||"________"}`,this.margin,o+l*4),s.text(`La somme de : ${r||"____________"} FCFA`,this.margin,o+l*6),s.text(`En paiement de : Frais de scolarit√© - ${a||"Ann√©e en cours"}`,this.margin,o+l*7),s.text(`Date du paiement : ${i||new Date().toLocaleDateString("fr-FR")}`,this.margin,o+l*8),s.text("Cette attestation est d√©livr√©e pour servir et valoir ce que de droit.",this.margin,o+l*10);const _=new Date().toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"});return s.text(`Fait √† ${(n==null?void 0:n.city)||"________"}, le ${_}`,this.pageWidth-this.margin-60,o+l*13),s.setFont("helvetica","bold"),s.text("Le(La) Comptable",this.pageWidth-this.margin-35,o+l*16),s}generateListeEleves(e){const{students:t,className:n,school:a,academicYear:r}=e,i=new C;i.setFontSize(14),i.setFont("helvetica","bold"),i.text((a==null?void 0:a.name)||"√âcole",this.pageWidth/2,20,{align:"center"}),i.setFontSize(16),i.text(`LISTE DES √âL√àVES - ${n||"Classe"}`,this.pageWidth/2,35,{align:"center"}),i.setFontSize(10),i.setFont("helvetica","normal"),i.text(`Ann√©e scolaire : ${r||"____-____"}`,this.pageWidth/2,43,{align:"center"}),i.text(`Effectif total : ${(t==null?void 0:t.length)||0} √©l√®ves`,this.pageWidth/2,50,{align:"center"});const s=60,o=[15,55,55,30,25],l=["N¬∞","Nom","Pr√©nom","Date naiss.","Sexe"];i.setFillColor(240,240,240),i.rect(this.margin,s-5,this.pageWidth-2*this.margin,10,"F"),i.setFont("helvetica","bold"),i.setFontSize(10);let c=this.margin+2;l.forEach((d,g)=>{i.text(d,c,s+2),c+=o[g]}),i.setFont("helvetica","normal"),i.setFontSize(9);let _=s+12;const h=t||[];h.forEach((d,g)=>{_>270&&(i.addPage(),_=30),c=this.margin+2,i.text(String(g+1),c,_),c+=o[0],i.text(d.last_name||"",c,_),c+=o[1],i.text(d.first_name||"",c,_),c+=o[2],i.text(this.formatDate(this.getBirthDate(d)),c,_),c+=o[3],i.text(d.gender||"",c,_),_+=7}),i.setDrawColor(200,200,200),i.setLineWidth(.1);for(let d=0;d<=h.length+1;d++){const g=s-5+d*7;g<280&&i.line(this.margin,g,this.pageWidth-this.margin,g)}return i}generateListeAppel(e){const{students:t,className:n,school:a,date:r}=e,i=new C("landscape"),s=297,o=210,l=15;i.setFontSize(12),i.setFont("helvetica","bold"),i.text((a==null?void 0:a.name)||"√âcole",l,15),i.setFontSize(14),i.text(`LISTE D'APPEL - ${n||"Classe"}`,s/2,15,{align:"center"}),i.setFontSize(10),i.setFont("helvetica","normal"),i.text(`Date : ${r||new Date().toLocaleDateString("fr-FR")}`,s-l,15,{align:"right"});const c=["Lun","Mar","Mer","Jeu","Ven"],_=30,h=8,d=80,g=35;i.setFillColor(240,240,240),i.rect(l,_-5,s-2*l,10,"F"),i.setFont("helvetica","bold"),i.setFontSize(9),i.text("N¬∞",l+2,_+2),i.text("Nom et Pr√©nom",l+15,_+2);let p=l+d;c.forEach(u=>{i.text(u,p+g/2,_+2,{align:"center"}),p+=g}),i.text("Obs.",p+10,_+2),i.setFont("helvetica","normal"),i.setFontSize(8);let m=_+12;return(t||[]).forEach((u,E)=>{m>o-20&&(i.addPage("landscape"),m=30),i.text(String(E+1),l+2,m),i.text(`${u.last_name||""} ${u.first_name||""}`,l+15,m),p=l+d,c.forEach(()=>{i.rect(p+5,m-5,g-10,h),p+=g}),m+=h}),i.setFontSize(8),i.text("P = Pr√©sent | A = Absent | R = Retard | E = Excus√©",l,o-10),i}generateCirculaire(e){const{school:t,title:n,content:a,date:r}=e,i=new C;i.setFontSize(14),i.setFont("helvetica","bold"),i.text("R√âPUBLIQUE DU CAMEROUN",this.pageWidth/2,20,{align:"center"}),i.setFontSize(10),i.setFont("helvetica","italic"),i.text("Paix - Travail - Patrie",this.pageWidth/2,26,{align:"center"}),i.setFont("helvetica","bold"),i.setFontSize(12),i.text((t==null?void 0:t.name)||"√âcole",this.pageWidth/2,40,{align:"center"}),i.setFontSize(10),i.setFont("helvetica","normal"),i.text((t==null?void 0:t.address)||"",this.pageWidth/2,47,{align:"center"}),i.setLineWidth(1),i.line(this.margin,55,this.pageWidth-this.margin,55),i.setFontSize(16),i.setFont("helvetica","bold"),i.text(n||"CIRCULAIRE",this.pageWidth/2,70,{align:"center"}),i.setFontSize(10),i.setFont("helvetica","normal"),i.text(`Date : ${r||new Date().toLocaleDateString("fr-FR")}`,this.pageWidth-this.margin,80,{align:"right"}),i.text("√Ä l'attention des Parents d'√©l√®ves",this.margin,90),i.setFontSize(11);const s=105;if(a){const o=i.splitTextToSize(a,this.pageWidth-2*this.margin);i.text(o,this.margin,s)}else i.text("Madame, Monsieur,",this.margin,s),i.text("",this.margin,s+15),i.text("[Contenu de la circulaire]",this.margin,s+25);return i.text("La Direction",this.pageWidth-this.margin-30,240),i}generate(e,t){switch(e){case"certificat_scolarite":return this.generateCertificatScolarite(t);case"certificat_frequentation":return this.generateCertificatFrequentation(t);case"fiche_inscription":return this.generateFicheInscription(t);case"attestation_paiement":return this.generateAttestationPaiement(t);case"liste_eleves":return this.generateListeEleves(t);case"liste_appel":return this.generateListeAppel(t);case"circulaire":case"convocation":case"avis_important":case"avis_paiement":return this.generateCirculaire({...t,title:this.getDocumentTitle(e)});default:return this.generateGenericDocument(t,e)}}getDocumentTitle(e){return{circulaire:"CIRCULAIRE",convocation:"CONVOCATION - R√âUNION PARENTS-ENSEIGNANTS",avis_important:"AVIS IMPORTANT",avis_paiement:"AVIS DE PAIEMENT",reglement_interieur:"R√àGLEMENT INT√âRIEUR",calendrier_scolaire:"CALENDRIER SCOLAIRE"}[e]||e.toUpperCase().replace(/_/g," ")}generateGenericDocument(e,t){const{school:n}=e,a=new C;return a.setFontSize(14),a.setFont("helvetica","bold"),a.text((n==null?void 0:n.name)||"√âcole",this.pageWidth/2,30,{align:"center"}),a.setFontSize(18),a.text(this.getDocumentTitle(t),this.pageWidth/2,60,{align:"center"}),a.setFontSize(12),a.setFont("helvetica","normal"),a.text(`Document g√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")}`,this.pageWidth/2,80,{align:"center"}),a.text("Ce document est en cours de d√©veloppement.",this.pageWidth/2,120,{align:"center"}),a}toBlob(e){return e.output("blob")}preview(e){const t=e.output("bloburl");window.open(t,"_blank")}download(e,t){e.save(t||"document.pdf")}}const O=new Y,P={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_ADSENSE_ID:"your-adsense-id-here",VITE_ANTHROPIC_API_KEY:"your-anthropic-api-key-here",VITE_EMAILJS_PUBLIC_KEY:"kFe4QRr9OaQAf8VXZ",VITE_EMAILJS_SERVICE_ID:"service_tuqh99q",VITE_EMAILJS_TEMPLATE_ID:"template_2cxezde",VITE_GEMINI_API_KEY:"your-gemini-api-key-here",VITE_GOOGLE_ANALYTICS_ID:"your-google-analytics-id-here",VITE_PERPLEXITY_API_KEY:"your-perplexity-api-key-here",VITE_STRIPE_PUBLISHABLE_KEY:"your-stripe-publishable-key-here",VITE_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxicXdibmNsa253c3pkbmx4YXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODMwNzEsImV4cCI6MjA3NzA1OTA3MX0.Jy7Vx_satR9CUGqMWSydr7Z6mwODNDTp3dD5PGmLq1w",VITE_SUPABASE_URL:"https://lbqwbnclknwszdnlxaxz.supabase.co"};var N={};class V{async getCurrentUserWithDbId(){var n,a,r,i,s,o,l;let e=null,t=null;try{const c=await((a=(n=f)==null?void 0:n.auth)==null?void 0:a.getUser());e=(r=c==null?void 0:c.data)==null?void 0:r.user,console.log("üîê Supabase Auth user:",(e==null?void 0:e.email)||"none")}catch{e=null}if(!e)try{const c=localStorage.getItem("edutrack-user");c&&(e=JSON.parse(c),console.log("üì¶ localStorage user:",e==null?void 0:e.email,"id:",e==null?void 0:e.id))}catch{}if(!e)return{user:null,dbUserId:null};if(e!=null&&e.email)try{console.log("üîç Searching user in DB by email:",e.email);const{data:c,error:_}=await((l=(o=(s=(i=f)==null?void 0:i.from("users"))==null?void 0:s.select("id, current_school_id"))==null?void 0:o.eq("email",e.email))==null?void 0:l.single());_&&console.error("‚ùå Error fetching user from DB:",_),c?(t=c.id,e.db_school_id=c.current_school_id,console.log("‚úÖ Found user in DB - dbUserId:",t,"school:",c.current_school_id)):console.warn("‚ö†Ô∏è User not found in DB for email:",e.email)}catch(c){console.warn("Could not fetch user from database:",c)}return!t&&(e!=null&&e.id)&&(console.log("‚ö†Ô∏è Using fallback user.id:",e.id),t=e.id),console.log("üìã getCurrentUserWithDbId result - dbUserId:",t),{user:e,dbUserId:t}}async uploadDocument(e,t){var n,a,r,i,s,o,l,c,_,h;try{const{user:d,dbUserId:g}=await this.getCurrentUserWithDbId();if(!d)throw new Error("Non authentifi√©");if(!g)throw new Error("Utilisateur non trouv√© dans la base de donn√©es. Veuillez vous reconnecter.");const p=typeof import.meta<"u"&&P&&void 0||typeof process<"u"&&N&&N.VITE_SUPABASE_STORAGE_BUCKET||"documents",m=Date.now(),b=((a=(n=t==null?void 0:t.name)==null?void 0:n.split("."))==null?void 0:a.pop())||"",u=`${(r=e==null?void 0:e.title)==null?void 0:r.replace(/\s+/g,"_")}_${m}.${b}`,E=((e==null?void 0:e.subject)||"general").toString().replace(/\s+/g,"_").toLowerCase(),F=`teacher/${g}/${E}/${u}`,{data:w,error:y}=await((o=(s=(i=f)==null?void 0:i.storage)==null?void 0:s.from(p))==null?void 0:o.upload(F,t,{cacheControl:"3600",upsert:!1}));if(y)throw y;const z=(e==null?void 0:e.school_id)||(d==null?void 0:d.current_school_id)||(d==null?void 0:d.db_school_id),{data:$,error:v}=await((h=(_=(c=(l=f)==null?void 0:l.from("documents"))==null?void 0:c.insert({title:e==null?void 0:e.title,description:e==null?void 0:e.description,file_name:t==null?void 0:t.name,file_path:F,file_size:t==null?void 0:t.size,mime_type:t==null?void 0:t.type,document_type:e==null?void 0:e.document_type,uploaded_by:g,class_name:e==null?void 0:e.class_name,subject:e==null?void 0:e.subject,school_id:z,is_public:(e==null?void 0:e.is_public)||!1}))==null?void 0:_.select())==null?void 0:h.single());if(v)throw v;return{data:$,error:null}}catch(d){return console.error("Erreur upload document:",d),{data:null,error:d==null?void 0:d.message}}}async getDocuments(e={}){var t,n,a;try{let r=(a=(n=(t=f)==null?void 0:t.from("documents"))==null?void 0:n.select(`
          id, title, description, file_name, file_path, file_size, mime_type,
          document_type, class_name, subject, is_public, created_at, updated_at,
          uploader:uploaded_by(id, full_name),
          school:school_id(id, name)
        `))==null?void 0:a.order("created_at",{ascending:!1});e!=null&&e.class_name&&(r=r==null?void 0:r.eq("class_name",e==null?void 0:e.class_name)),e!=null&&e.subject&&(r=r==null?void 0:r.eq("subject",e==null?void 0:e.subject)),e!=null&&e.document_type&&(r=r==null?void 0:r.eq("document_type",e==null?void 0:e.document_type)),e!=null&&e.school_id&&(r=r==null?void 0:r.eq("school_id",e==null?void 0:e.school_id));const{data:i,error:s}=await r;if(s)throw s;return{data:i,error:null}}catch(r){return console.error("Erreur r√©cup√©ration documents:",r),{data:[],error:r==null?void 0:r.message}}}async getTeacherDocuments(){var e,t;try{const{data:{user:n}}=await((t=(e=f)==null?void 0:e.auth)==null?void 0:t.getUser());if(!n)throw new Error("Non authentifi√©");return await this.getDocuments({uploaded_by:n==null?void 0:n.id})}catch(n){return console.error("Erreur r√©cup√©ration documents professeur:",n),{data:[],error:n==null?void 0:n.message}}}async getStudentDocuments(){var e,t,n,a,r,i;try{const{data:{user:s}}=await((t=(e=f)==null?void 0:e.auth)==null?void 0:t.getUser());if(!s)throw new Error("Non authentifi√©");const{data:o,error:l}=await((i=(r=(a=(n=f)==null?void 0:n.from("students"))==null?void 0:a.select("current_class, current_school_id"))==null?void 0:r.eq("user_id",s==null?void 0:s.id))==null?void 0:i.single());return l||!o?{data:[],error:"Informations √©tudiant non trouv√©es"}:await this.getDocuments({class_name:o==null?void 0:o.current_class,school_id:o==null?void 0:o.current_school_id})}catch(s){return console.error("Erreur r√©cup√©ration documents √©tudiant:",s),{data:[],error:s==null?void 0:s.message}}}async deleteDocument(e){var t,n,a,r,i,s,o,l,c,_;try{const{user:h,dbUserId:d}=await this.getCurrentUserWithDbId();if(!h||!d)throw new Error("Non authentifi√©");const{data:g,error:p}=await((r=(a=(n=(t=f)==null?void 0:t.from("documents"))==null?void 0:n.select("file_path, uploaded_by"))==null?void 0:a.eq("id",e))==null?void 0:r.single());if(p||!g)throw new Error("Document non trouv√©");if((g==null?void 0:g.uploaded_by)!==d)throw new Error("Non autoris√© √† supprimer ce document");const m=typeof import.meta<"u"&&P&&void 0||typeof process<"u"&&N&&N.VITE_SUPABASE_STORAGE_BUCKET||"documents",{error:b}=await((o=(s=(i=f)==null?void 0:i.storage)==null?void 0:s.from(m))==null?void 0:o.remove([g==null?void 0:g.file_path]));b&&console.error("Erreur suppression storage:",b);const{error:u}=await((_=(c=(l=f)==null?void 0:l.from("documents"))==null?void 0:c.delete())==null?void 0:_.eq("id",e));if(u)throw u;return{data:!0,error:null}}catch(h){return console.error("Erreur suppression document:",h),{data:!1,error:h==null?void 0:h.message}}}async downloadDocument(e,t="download"){var n,a,r,i,s,o,l;try{const{user:c,dbUserId:_}=await this.getCurrentUserWithDbId();if(!c||!_)throw new Error("Non authentifi√©");const{data:h,error:d}=await((i=(r=(a=(n=f)==null?void 0:n.from("documents"))==null?void 0:a.select("file_path, file_name, title"))==null?void 0:r.eq("id",e))==null?void 0:i.single());if(d||!h)throw new Error("Document non trouv√©");const g=typeof import.meta<"u"&&P&&void 0||typeof process<"u"&&N&&N.VITE_SUPABASE_STORAGE_BUCKET||"documents",{data:p,error:m}=await((l=(o=(s=f)==null?void 0:s.storage)==null?void 0:o.from(g))==null?void 0:l.createSignedUrl(h==null?void 0:h.file_path,3600));if(m||!p)throw new Error("Impossible de g√©n√©rer l'URL de t√©l√©chargement");return await this.logDocumentAccess(e,t),{data:{url:p==null?void 0:p.signedUrl,fileName:h==null?void 0:h.file_name,title:h==null?void 0:h.title},error:null}}catch(c){return console.error("Erreur t√©l√©chargement document:",c),{data:null,error:c==null?void 0:c.message}}}async uploadTeacherDocument(e,t){var n,a,r,i,s,o,l,c,_,h,d,g,p;try{const{user:m,dbUserId:b}=await this.getCurrentUserWithDbId();if(!m)throw new Error("Non authentifi√©");if(!b)throw new Error("Utilisateur non trouv√© dans la base de donn√©es. Veuillez vous reconnecter.");let u=(m==null?void 0:m.current_school_id)||(m==null?void 0:m.school_id)||(m==null?void 0:m.db_school_id)||(e==null?void 0:e.school_id);if(!u&&b)try{const{data:A}=await((i=(r=(a=(n=f)==null?void 0:n.from("users"))==null?void 0:a.select("current_school_id"))==null?void 0:r.eq("id",b))==null?void 0:i.single());u=A==null?void 0:A.current_school_id}catch(A){console.warn("Impossible de r√©cup√©rer school_id:",A)}if(!u)throw new Error("√âcole non trouv√©e - veuillez vous reconnecter");const E=typeof import.meta<"u"&&P&&void 0||typeof process<"u"&&N&&N.VITE_SUPABASE_STORAGE_BUCKET||"documents";console.log("üì§ Upload document - bucket:",E,"dbUserId:",b,"school:",u);const F=Date.now(),w=((o=(s=t==null?void 0:t.name)==null?void 0:s.split("."))==null?void 0:o.pop())||"",z=`${((e==null?void 0:e.title)||"document").toString().replace(/[^a-zA-Z0-9_-]/g,"_")}_${F}.${w}`,$=`teacher/${b}/${z}`,{data:v,error:U}=await((_=(c=(l=f)==null?void 0:l.storage)==null?void 0:c.from(E))==null?void 0:_.upload($,t,{cacheControl:"3600",upsert:!1}));if(U)throw console.error("‚ùå Storage error:",U),U;console.log("‚úÖ Fichier upload√©:",$);let T="class";(e==null?void 0:e.visibility)==="students"?T="class":(e==null?void 0:e.visibility)==="students_parents"?T="school":(e==null?void 0:e.visibility)==="private"&&(T="private"),console.log("üìã documentData re√ßu:",e);const I={school_id:u,document_type:(e==null?void 0:e.document_type)||(e==null?void 0:e.type)||"cours",visibility:T,is_public:(e==null?void 0:e.visibility)==="students_parents",uploaded_by:b,title:e==null?void 0:e.title,file_name:t==null?void 0:t.name,file_path:$,mime_type:t==null?void 0:t.type,class_name:(e==null?void 0:e.class_name)||(e==null?void 0:e.class_id)};console.log("üìù Insertion document record:",I);const{data:L,error:x}=await((p=(g=(d=(h=f)==null?void 0:h.from("documents"))==null?void 0:d.insert(I))==null?void 0:g.select())==null?void 0:p.single());if(x)throw console.error("‚ùå DB insert error:",x),x;return console.log("‚úÖ Document enregistr√©:",L==null?void 0:L.id),{data:L,error:null}}catch(m){return console.error("Erreur upload teacher document:",m),{data:null,error:(m==null?void 0:m.message)||String(m)}}}async logDocumentAccess(e,t){var n;try{const{error:a}=await((n=f)==null?void 0:n.rpc("log_document_access",{doc_id:e,access_action:t}));a&&console.error("Erreur log acc√®s document:",a)}catch(a){console.error("Erreur log acc√®s document:",a)}}async getTeacherAssignments(){var e,t,n,a,r,i,s;try{const{data:{user:o}}=await((t=(e=f)==null?void 0:e.auth)==null?void 0:t.getUser());if(!o)throw new Error("Non authentifi√©");const{data:l,error:c}=await((s=(i=(r=(a=(n=f)==null?void 0:n.from("teacher_assignments"))==null?void 0:a.select(`
          id, class_name, subject, assigned_at, is_active,
          school:school_id(id, name),
          assigned_by_user:assigned_by(id, full_name)
        `))==null?void 0:r.eq("teacher_id",o==null?void 0:o.id))==null?void 0:i.eq("is_active",!0))==null?void 0:s.order("assigned_at",{ascending:!1}));if(c)throw c;return{data:l,error:null}}catch(o){return console.error("Erreur r√©cup√©ration assignments:",o),{data:[],error:o==null?void 0:o.message}}}async assignTeacherToClass(e){var t,n,a,r,i,s;try{const{data:{user:o}}=await((n=(t=f)==null?void 0:t.auth)==null?void 0:n.getUser());if(!o)throw new Error("Non authentifi√©");const{data:l,error:c}=await((s=(i=(r=(a=f)==null?void 0:a.from("teacher_assignments"))==null?void 0:r.insert({teacher_id:e==null?void 0:e.teacher_id,school_id:e==null?void 0:e.school_id,class_name:e==null?void 0:e.class_name,subject:e==null?void 0:e.subject,assigned_by:o==null?void 0:o.id}))==null?void 0:i.select())==null?void 0:s.single());if(c)throw c;return{data:l,error:null}}catch(o){return console.error("Erreur assignation professeur:",o),{data:null,error:o==null?void 0:o.message}}}async removeTeacherAssignment(e){var t,n,a;try{const{error:r}=await((a=(n=(t=f)==null?void 0:t.from("teacher_assignments"))==null?void 0:n.update({is_active:!1}))==null?void 0:a.eq("id",e));if(r)throw r;return{data:!0,error:null}}catch(r){return console.error("Erreur suppression assignation:",r),{data:!1,error:r==null?void 0:r.message}}}async getClassesAndSubjects(){var e,t,n;try{const{data:a,error:r}=await((n=(t=(e=f)==null?void 0:e.from("teacher_assignments"))==null?void 0:t.select("class_name, subject"))==null?void 0:n.eq("is_active",!0));if(r)throw r;const i=[...new Set((a==null?void 0:a.map(o=>o.class_name))||[])],s=[...new Set((a==null?void 0:a.map(o=>o.subject))||[])];return{data:{classes:i,subjects:s},error:null}}catch(a){return console.error("Erreur r√©cup√©ration classes/mati√®res:",a),{data:{classes:[],subjects:[]},error:a==null?void 0:a.message}}}async getDocumentStats(){var e,t,n,a,r,i,s;try{const{data:{user:o}}=await((t=(e=f)==null?void 0:e.auth)==null?void 0:t.getUser());if(!o)throw new Error("Non authentifi√©");const{data:l,error:c}=await((r=(a=(n=f)==null?void 0:n.from("documents"))==null?void 0:a.select("document_type, created_at"))==null?void 0:r.eq("uploaded_by",o==null?void 0:o.id));if(c)throw c;const _={total:(l==null?void 0:l.length)||0,byType:{},thisMonth:0},h=(i=new Date)==null?void 0:i.getMonth(),d=(s=new Date)==null?void 0:s.getFullYear();return l==null||l.forEach(g=>{var m;_.byType[g.document_type]=(((m=_==null?void 0:_.byType)==null?void 0:m[g==null?void 0:g.document_type])||0)+1;const p=new Date(g.created_at);(p==null?void 0:p.getMonth())===h&&(p==null?void 0:p.getFullYear())===d&&_.thisMonth++}),{data:_,error:null}}catch(o){return console.error("Erreur statistiques documents:",o),{data:null,error:o==null?void 0:o.message}}}async getAllSchoolDocuments(){var e,t,n,a,r,i,s,o,l,c,_;try{let h=null,d=null;const{data:{user:g}}=await((t=(e=f)==null?void 0:e.auth)==null?void 0:t.getUser());if(g){d=g.id;const{data:u}=await((i=(r=(a=(n=f)==null?void 0:n.from("users"))==null?void 0:a.select("current_school_id"))==null?void 0:r.eq("id",g.id))==null?void 0:i.single());h=u==null?void 0:u.current_school_id}else{const u=localStorage.getItem("edutrack-user");if(u){const E=JSON.parse(u);d=E.id,h=E.current_school_id||E.school_id,console.log("‚úÖ Utilisation localStorage pour documents:",{userId:d,schoolId:h})}}if(!h)return{success:!1,documents:[],error:"√âcole non trouv√©e"};const{data:p,error:m}=await((c=(l=(o=(s=f)==null?void 0:s.from("documents"))==null?void 0:o.select(`
          id,
          title,
          document_type,
          created_at,
          file_name,
          file_path,
          mime_type,
          class_name
        `))==null?void 0:l.eq("school_id",h))==null?void 0:c.order("created_at",{ascending:!1}));if(m)throw m;return{success:!0,documents:(p||[]).map(u=>{var E,F;return{id:u.id,name:u.title,type:u.document_type||"administratif",dateCreated:new Date(u.created_at).toLocaleDateString("fr-FR"),status:"generated",studentName:u.class_name||"Document g√©n√©ral",class:u.class_name||"N/A",format:((F=(E=u.mime_type)==null?void 0:E.split("/")[1])==null?void 0:F.toUpperCase())||"PDF",file_path:u.file_path,file_name:u.file_name}}),error:null}}catch(h){return console.error("Erreur r√©cup√©ration documents √©cole:",h),(_=h.message)!=null&&_.includes("Could not find the table")?{success:!1,documents:[],error:"TABLE_NOT_EXISTS",message:"La table documents n'existe pas encore dans Supabase. Cr√©ez-la pour activer cette fonctionnalit√©."}:{success:!1,documents:[],error:h==null?void 0:h.message}}}async generateDocument(e,t={}){var n,a,r,i,s,o,l,c,_,h,d,g,p,m,b,u,E,F;try{const{studentId:w=null,classId:y=null,visibility:z="private",isPublic:$=!1}=t;let v=null,U=null,T=null,I=null,L=[],x=null;const A=localStorage.getItem("edutrack-user");if(A){const S=JSON.parse(A);U=S.id,v=S.current_school_id||S.school_id,T=S.schoolData||{name:S.school_name}}if(!v){const{data:{user:S}}=await((a=(n=f)==null?void 0:n.auth)==null?void 0:a.getUser());if(S){U=S.id;const{data:W}=await((o=(s=(i=(r=f)==null?void 0:r.from("users"))==null?void 0:i.select("current_school_id, school:schools!users_current_school_id_fkey(id, name, address, city, country)"))==null?void 0:s.eq("id",S.id))==null?void 0:o.single());v=W==null?void 0:W.current_school_id,T=W==null?void 0:W.school}}if(!v)throw new Error("√âcole non trouv√©e");const R=[];w&&R.push((h=(_=(c=(l=f)==null?void 0:l.from("students"))==null?void 0:c.select("*"))==null?void 0:_.eq("id",w))==null?void 0:h.single().then(({data:S})=>{I=S})),y&&(R.push((m=(p=(g=(d=f)==null?void 0:d.from("classes"))==null?void 0:g.select("*"))==null?void 0:p.eq("id",y))==null?void 0:m.single().then(({data:S})=>{x=S})),R.push((F=(E=(u=(b=f)==null?void 0:b.from("students"))==null?void 0:u.select("*"))==null?void 0:E.eq("class_id",y))==null?void 0:F.order("last_name").then(({data:S})=>{L=S||[]}))),R.length>0&&await Promise.all(R);const M={student:I,students:L,school:T,className:(x==null?void 0:x.name)||(I==null?void 0:I.class_name),academicYear:`${new Date().getFullYear()}-${new Date().getFullYear()+1}`,date:new Date().toLocaleDateString("fr-FR")},B=O.generate(e,M);return O.preview(B),this.saveDocumentInBackground(B,e,{schoolId:v,userId:U,studentId:w,classId:y,visibility:z,isPublic:$,studentData:I,classData:x,pdfGenerator:O}),{success:!0,document:null,error:null}}catch(w){return console.error("Erreur g√©n√©ration document:",w),{success:!1,document:null,error:w==null?void 0:w.message}}}async saveDocumentInBackground(e,t,n){var d,g;const{schoolId:a,userId:r,studentId:i,classId:s,visibility:o,isPublic:l,studentData:c,classData:_,pdfGenerator:h}=n;try{const p=h.toBlob(e),m=Date.now(),b=`${t}_${m}.pdf`,u=`school_${a}/documents/${b}`,{error:E}=await f.storage.from("documents").upload(u,p,{contentType:"application/pdf",upsert:!1});E&&console.warn("‚ö†Ô∏è Erreur upload Storage:",E.message);const F=this.generateDocumentTitle(t,c,_),w={title:F,document_type:t,school_id:a,file_name:b,file_path:E?null:u,file_size:p.size,mime_type:"application/pdf",visibility:o,is_public:l};i&&(w.target_student_id=i),s&&(w.target_class_id=s),r&&r.length===36&&(w.uploaded_by=r);const{error:y}=await((g=(d=f)==null?void 0:d.from("documents"))==null?void 0:g.insert(w));y?console.error("‚ùå Erreur insertion document:",y.message,y.details):console.log("‚úÖ Document sauvegard√© en arri√®re-plan:",F)}catch(p){console.warn("‚ö†Ô∏è Erreur sauvegarde en arri√®re-plan:",p)}}generateDocumentTitle(e,t,n){const r={certificat_scolarite:"Certificat de scolarit√©",certificat_frequentation:"Certificat de fr√©quentation",fiche_inscription:"Fiche d'inscription",attestation_paiement:"Attestation de paiement",autorisation_sortie:"Autorisation de sortie",bulletin:"Bulletin scolaire",liste_eleves:"Liste des √©l√®ves",liste_appel:"Liste d'appel",emploi_du_temps:"Emploi du temps",certificats_classe:"Certificats de classe",statistiques_classe:"Statistiques de classe",bulletin_classe:"Bulletins de classe",reglement_interieur:"R√®glement int√©rieur",calendrier_scolaire:"Calendrier scolaire",circulaire:"Circulaire",convocation:"Convocation",avis_important:"Avis important",avis_paiement:"Avis de paiement"}[e]||e;return t?`${r} - ${t.last_name} ${t.first_name}`:n?`${r} - ${n.name}`:r}}const J=new V;export{J as d};
//# sourceMappingURL=documentService-BNZuJcP9.js.map
