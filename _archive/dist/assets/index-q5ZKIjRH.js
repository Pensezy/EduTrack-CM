import{j as e}from"./contexts-fbpOeTmm.js";import{r as l}from"./react-vendor-CFDIsUAY.js";import{H as T}from"./Helmet-B3bMicap.js";import{H,S as I}from"./Sidebar-Q0ML3SY6.js";import{I as i,a as q,B as C}from"./index-BPV3rumr.js";import{u as B}from"./useDashboardData-CL9BpvNP.js";import{s as g}from"./services-CdXttHtG.js";import{i as P,a as F}from"./emailService-yXWWlP6-.js";import"./charts-vendor-i33Lw0zL.js";import"./ui-vendor-BrXTGbgA.js";import"./supabase-CIvuJI4W.js";import"./productionDataService-T6uUAzM-.js";const X=()=>{var N,b,v,y,_;const[o,E]=l.useState(!1),[u,f]=l.useState(!1),[S,D]=l.useState([]),[t,h]=l.useState({title:"",message:"",target:"all",priority:"normal",type:"info"}),{user:s}=B();l.useEffect(()=>{s!=null&&s.current_school_id&&p()},[s==null?void 0:s.current_school_id]);const p=async()=>{try{const{data:a,error:r}=await g.from("notifications").select("*").eq("school_id",s.current_school_id).order("sent_at",{ascending:!1}).limit(10);if(r)throw r;D(a||[])}catch(a){console.error("‚ùå Erreur chargement notifications:",a)}},j=()=>{E(!o)},c=a=>{const{name:r,value:d}=a.target;h(x=>({...x,[r]:d}))},k=async()=>{var a;if(!t.title||!t.message){alert("Veuillez remplir le titre et le message");return}f(!0);try{console.log("Envoi de la notification...");let r=[];const{current_school_id:d}=s;if(t.target!=="all"){const n=t.target==="parents"?"parents":t.target==="students"?"students":t.target==="teachers"?"teachers":t.target==="staff"?"users":null;if(n){const R=g.from(n).select("email, full_name").eq("school_id",d).eq("is_active",!0),{data:z}=await R;r=(z||[]).filter(m=>m.email).map(m=>({email:m.email,name:m.full_name}))}}const{data:x,error:w}=await g.from("notifications").insert({school_id:d,sender_id:s.id,title:t.title,message:t.message,target:t.target,priority:t.priority,type:t.type,status:"sent",recipients_count:r.length}).select().single();if(w)throw w;if(console.log("‚úÖ Notification sauvegard√©e:",x),P()&&r.length>0){const n=await F({title:t.title,message:t.message,target:t.target,priority:t.priority,type:t.type,schoolName:((a=s.schoolData)==null?void 0:a.name)||"√âcole",senderName:s.full_name||"Directeur",recipients:r});console.log("üìß R√©sultat envoi emails:",n),alert(`‚úÖ Notification envoy√©e !

${n.message}

Notification sauvegard√©e dans le syst√®me.`)}else alert(`‚úÖ Notification enregistr√©e avec succ√®s !

Note : Service d'email non configur√©.`);await p(),h({title:"",message:"",target:"all",priority:"normal",type:"info"})}catch(r){console.error("Erreur:",r),alert("Erreur lors de l'envoi : "+r.message)}finally{f(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(T,{children:[e.jsx("title",{children:"Gestion des Notifications - EduTrack CM"}),e.jsx("meta",{name:"description",content:"G√©rer et envoyer des notifications √† l'√©cole"})]}),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(H,{userRole:"principal",userName:((N=s==null?void 0:s.schoolData)==null?void 0:N.director_name)||((v=(b=s==null?void 0:s.schoolData)==null?void 0:b.users)==null?void 0:v.full_name)||(s==null?void 0:s.full_name)||((y=s==null?void 0:s.email)==null?void 0:y.split("@")[0])||"Directeur",isCollapsed:o,onToggleSidebar:j}),e.jsxs("div",{className:"flex pt-16",children:[e.jsx(I,{userRole:"principal",isCollapsed:o,onToggle:j}),e.jsxs("main",{className:`flex-1 transition-all duration-300 ${o?"lg:ml-20":"lg:ml-64"} p-6`,children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(i,{name:"Bell",size:20,className:"text-primary"})}),e.jsx("h1",{className:"text-2xl font-heading font-heading-bold text-foreground",children:"Gestion des Notifications"})]})}),e.jsxs("p",{className:"text-muted-foreground",children:["Envoyer des notifications et messages √† ",((_=s==null?void 0:s.schoolData)==null?void 0:_.name)||"votre √©cole"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-card border border-border rounded-lg p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-6",children:[e.jsx(i,{name:"Plus",size:20,className:"text-primary"}),e.jsx("h2",{className:"text-lg font-heading font-heading-semibold text-card-foreground",children:"Nouvelle Notification"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Titre"}),e.jsx(q,{name:"title",value:t.title,onChange:c,placeholder:"Titre de la notification",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Message"}),e.jsx("textarea",{name:"message",value:t.message,onChange:c,placeholder:"Contenu du message...",rows:4,className:"w-full p-3 border border-input bg-background rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Destinataires"}),e.jsxs("select",{name:"target",value:t.target,onChange:c,className:"w-full p-3 border border-input bg-background rounded-md focus:outline-none focus:ring-2 focus:ring-primary",children:[e.jsx("option",{value:"all",children:"Tout le monde"}),e.jsx("option",{value:"students",children:"√âl√®ves"}),e.jsx("option",{value:"teachers",children:"Enseignants"}),e.jsx("option",{value:"parents",children:"Parents"}),e.jsx("option",{value:"staff",children:"Personnel"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Priorit√©"}),e.jsxs("select",{name:"priority",value:t.priority,onChange:c,className:"w-full p-3 border border-input bg-background rounded-md focus:outline-none focus:ring-2 focus:ring-primary",children:[e.jsx("option",{value:"low",children:"Faible"}),e.jsx("option",{value:"normal",children:"Normale"}),e.jsx("option",{value:"high",children:"√âlev√©e"}),e.jsx("option",{value:"urgent",children:"Urgente"})]})]})]}),e.jsxs(C,{onClick:k,className:"w-full",disabled:!t.title||!t.message||u,loading:u,children:[e.jsx(i,{name:"Send",size:16,className:"mr-2"}),u?"Envoi en cours...":"Envoyer la Notification"]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-lg p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(i,{name:"History",size:20,className:"text-primary"}),e.jsx("h2",{className:"text-lg font-heading font-heading-semibold text-card-foreground",children:"Notifications R√©centes"})]}),e.jsx(C,{variant:"ghost",size:"sm",children:e.jsx(i,{name:"RefreshCw",size:14})})]}),e.jsx("div",{className:"space-y-4",children:S.map(a=>e.jsxs("div",{className:"p-4 border border-border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("h3",{className:"font-medium text-foreground",children:a.title})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(a.sent_at||a.date).toLocaleDateString("fr-FR")})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:a.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-primary/10 text-primary",children:a.target}),e.jsxs("div",{className:"flex items-center space-x-2",children:[a.recipients_count>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[a.recipients_count," destinataire(s)"]}),e.jsxs("span",{className:"text-xs flex items-center text-success",children:[e.jsx(i,{name:"CheckCircle",size:12,className:"mr-1"}),a.status==="sent"?"Envoy√©":"√âchou√©"]})]})]})]},a.id))})]})]})]})]})]})]})};export{X as default};
//# sourceMappingURL=index-q5ZKIjRH.js.map
