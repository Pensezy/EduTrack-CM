{"version":3,"file":"schoolService-B_ZAdpzo.js","sources":["../../src/services/configurationService.js","../../src/services/schoolService.js"],"sourcesContent":["import { supabase } from \"../lib/supabase.js\";\r\n\r\nexport class ConfigurationService {\r\n  static async initializeSchoolConfigurations(schoolId) {\r\n    console.log(\"‚öôÔ∏è Initialisation des configurations pour l'√©cole: \" + schoolId);\r\n    \r\n    const results = {\r\n      gradeTypes: [],\r\n      attendanceTypes: [],\r\n      userRoles: [],\r\n      errors: []\r\n    };\r\n\r\n    try {\r\n      // 1. Initialiser les types de notes par d√©faut\r\n      const defaultGradeTypes = [\r\n        { school_id: schoolId, name: 'Devoir Surveill√©', code: 'DS', coefficient: 1.0, description: '√âvaluation formelle en classe' },\r\n        { school_id: schoolId, name: 'Devoir Maison', code: 'DM', coefficient: 0.5, description: 'Travail √† faire √† la maison' },\r\n        { school_id: schoolId, name: 'Contr√¥le Continu', code: 'CC', coefficient: 1.0, description: '√âvaluation continue' },\r\n        { school_id: schoolId, name: 'Examen Final', code: 'EF', coefficient: 2.0, description: 'Examen de fin de p√©riode' },\r\n        { school_id: schoolId, name: 'Projet', code: 'PROJ', coefficient: 1.5, description: 'Travail de projet' }\r\n      ];\r\n\r\n      const { data: gradeTypesData, error: gradeTypesError } = await supabase\r\n        .from('grade_types')\r\n        .insert(defaultGradeTypes)\r\n        .select();\r\n\r\n      if (gradeTypesError) {\r\n        console.warn('‚ö†Ô∏è Erreur cr√©ation types de notes:', gradeTypesError);\r\n        results.errors.push({ type: 'gradeTypes', error: gradeTypesError.message });\r\n      } else {\r\n        results.gradeTypes = gradeTypesData;\r\n        console.log('‚úÖ Types de notes cr√©√©s:', gradeTypesData.length);\r\n      }\r\n\r\n      // 2. Initialiser les types de pr√©sence par d√©faut\r\n      const defaultAttendanceTypes = [\r\n        { school_id: schoolId, name: 'Pr√©sent', code: 'PRESENT', description: '√âl√®ve pr√©sent en cours' },\r\n        { school_id: schoolId, name: 'Absent', code: 'ABSENT', description: '√âl√®ve absent non justifi√©' },\r\n        { school_id: schoolId, name: 'Retard', code: 'LATE', description: '√âl√®ve en retard' },\r\n        { school_id: schoolId, name: 'Justifi√©', code: 'JUSTIFIED', description: 'Absence justifi√©e' },\r\n        { school_id: schoolId, name: 'Exempt√©', code: 'EXEMPT', description: '√âl√®ve exempt√© de cours' }\r\n      ];\r\n\r\n      const { data: attendanceTypesData, error: attendanceTypesError } = await supabase\r\n        .from('attendance_types')\r\n        .insert(defaultAttendanceTypes)\r\n        .select();\r\n\r\n      if (attendanceTypesError) {\r\n        console.warn('‚ö†Ô∏è Erreur cr√©ation types de pr√©sence:', attendanceTypesError);\r\n        results.errors.push({ type: 'attendanceTypes', error: attendanceTypesError.message });\r\n      } else {\r\n        results.attendanceTypes = attendanceTypesData;\r\n        console.log('‚úÖ Types de pr√©sence cr√©√©s:', attendanceTypesData.length);\r\n      }\r\n\r\n      // 3. Initialiser les r√¥les utilisateur par d√©faut\r\n      const defaultUserRoles = [\r\n        { school_id: schoolId, name: 'Enseignant', code: 'TEACHER', permissions: ['view_grades', 'view_students', 'manage_attendance'] },\r\n        { school_id: schoolId, name: 'Secr√©taire', code: 'SECRETARY', permissions: ['manage_students', 'manage_payments', 'manage_documents'] },\r\n        { school_id: schoolId, name: 'Surveillant', code: 'MONITOR', permissions: ['view_students', 'manage_attendance'] },\r\n        { school_id: schoolId, name: 'Coordinateur', code: 'COORDINATOR', permissions: ['manage_teachers', 'view_analytics', 'manage_classes'] }\r\n      ];\r\n\r\n      const { data: userRolesData, error: userRolesError } = await supabase\r\n        .from('user_roles')\r\n        .insert(defaultUserRoles)\r\n        .select();\r\n\r\n      if (userRolesError) {\r\n        console.warn('‚ö†Ô∏è Erreur cr√©ation r√¥les utilisateur:', userRolesError);\r\n        results.errors.push({ type: 'userRoles', error: userRolesError.message });\r\n      } else {\r\n        results.userRoles = userRolesData;\r\n        console.log('‚úÖ R√¥les utilisateur cr√©√©s:', userRolesData.length);\r\n      }\r\n\r\n      results.success = results.errors.length === 0;\r\n      return results;\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Erreur lors de l\\'initialisation des configurations:', error);\r\n      results.errors.push({ type: 'general', error: error.message });\r\n      results.success = false;\r\n      return results;\r\n    }\r\n  }\r\n\r\n  static async getDefaultConfigurations() {\r\n    return {\r\n      gradeTypes: [\r\n        { name: 'Devoir Surveill√©', code: 'DS', coefficient: 1.0 },\r\n        { name: 'Devoir Maison', code: 'DM', coefficient: 0.5 },\r\n        { name: 'Contr√¥le Continu', code: 'CC', coefficient: 1.0 },\r\n        { name: 'Examen Final', code: 'EF', coefficient: 2.0 }\r\n      ],\r\n      attendanceTypes: [\r\n        { name: 'Pr√©sent', code: 'PRESENT' },\r\n        { name: 'Absent', code: 'ABSENT' },\r\n        { name: 'Retard', code: 'LATE' },\r\n        { name: 'Justifi√©', code: 'JUSTIFIED' }\r\n      ],\r\n      userRoles: [\r\n        { name: 'Enseignant', code: 'TEACHER' },\r\n        { name: 'Secr√©taire', code: 'SECRETARY' },\r\n        { name: 'Surveillant', code: 'MONITOR' }\r\n      ]\r\n    };\r\n  }\r\n\r\n  static async initializeEvaluationPeriods(schoolId, academicYearId, schoolType) {\r\n    console.log(\"üìÖ Initialisation des p√©riodes d'√©valuation pour:\", schoolType);\r\n    \r\n    // D√©terminer les p√©riodes selon le type d'√©tablissement\r\n    let periods = [];\r\n    const basePeriods = [\r\n      { name: 'Premier Trimestre', start_date: '2024-09-01', end_date: '2024-11-30' },\r\n      { name: 'Deuxi√®me Trimestre', start_date: '2024-12-01', end_date: '2025-03-31' },\r\n      { name: 'Troisi√®me Trimestre', start_date: '2025-04-01', end_date: '2025-07-31' }\r\n    ];\r\n\r\n    if (schoolType.includes('lyc√©e') || schoolType.includes('college') || schoolType.includes('secondaire')) {\r\n      periods = basePeriods;\r\n    } else if (schoolType.includes('primaire')) {\r\n      periods = basePeriods;\r\n    } else {\r\n      // Par d√©faut, utiliser les trimestres\r\n      periods = basePeriods;\r\n    }\r\n\r\n    // Ajouter l'ID de l'√©cole et de l'ann√©e acad√©mique\r\n    const periodsToInsert = periods.map(period => ({\r\n      ...period,\r\n      school_id: schoolId,\r\n      academic_year_id: academicYearId,\r\n      is_current: period.name === 'Premier Trimestre' // Premier trimestre actif par d√©faut\r\n    }));\r\n\r\n    const { data, error } = await supabase\r\n      .from('evaluation_periods')\r\n      .insert(periodsToInsert)\r\n      .select();\r\n\r\n    if (error) {\r\n      console.warn('‚ö†Ô∏è Erreur cr√©ation p√©riodes d\\'√©valuation:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('‚úÖ P√©riodes d\\'√©valuation cr√©√©es:', data.length);\r\n    return data;\r\n  }\r\n}\r\n\r\nexport default ConfigurationService;","// Service principal pour l'authentification et la gestion des √©coles\r\n// Utilise Supabase pour les op√©rations c√¥t√© client\r\n\r\nimport { supabase } from '../lib/supabase';\r\nimport databaseService from './databaseService';\r\nimport { getCurrentAcademicYear, getAcademicYearDates } from '../utils/academicYear';\r\nimport ConfigurationService from './configurationService';\r\n\r\n/**\r\n * Service pour cr√©er une √©cole et lier un directeur\r\n */\r\n\r\n/**\r\n * Service pour cr√©er une √©cole et lier un directeur\r\n * Utilise Supabase directement (compatible c√¥t√© client)\r\n */\r\nexport const createPrincipalSchool = async ({\r\n  directorName,\r\n  email,\r\n  phone,\r\n  schoolName,\r\n  schoolType,\r\n  address,\r\n  city = 'Yaound√©',\r\n  country = 'Cameroun',\r\n  availableClasses = [],\r\n  userId = null // ID utilisateur Supabase Auth\r\n}) => {\r\n  try {\r\n    console.log('üè´ Service createPrincipalSchool appel√© avec:', {\r\n      directorName,\r\n      email,\r\n      schoolName,\r\n      schoolType,\r\n      userId\r\n    });\r\n\r\n    let authUserId = userId;\r\n    \r\n    // 1. Si pas d'userId fourni, r√©cup√©rer l'utilisateur actuel connect√©\r\n    if (!authUserId) {\r\n      const { data: currentUser, error: currentUserError } = await supabase.auth.getUser();\r\n      \r\n      if (currentUserError || !currentUser?.user) {\r\n        throw new Error('Aucun utilisateur connect√©. Veuillez vous reconnecter.');\r\n      }\r\n      \r\n      authUserId = currentUser.user.id;\r\n    }\r\n\r\n    console.log('üë§ Utilisation de l\\'ID utilisateur:', authUserId);\r\n\r\n    // 2. V√©rifier si l'utilisateur a d√©j√† une √©cole - avec gestion d'erreurs am√©lior√©e\r\n    let existingSchools = [];\r\n    let checkError = null;\r\n    \r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('schools')\r\n        .select('id, name')\r\n        .eq('director_user_id', authUserId);\r\n      \r\n      if (error) {\r\n        console.warn('‚ö†Ô∏è Erreur v√©rification √©cole existante (non bloquante):', error);\r\n        checkError = error;\r\n        // Ne pas lancer d'exception ici, continuer avec la cr√©ation\r\n      } else {\r\n        existingSchools = data;\r\n      }\r\n    } catch (err) {\r\n      console.warn('‚ö†Ô∏è Exception lors de la v√©rification √©cole existante (non bloquante):', err);\r\n      checkError = err;\r\n    }\r\n\r\n    // Si l'utilisateur a d√©j√† une √©cole, on continue quand m√™me (mode d√©grad√©)\r\n    if (existingSchools && existingSchools.length > 0) {\r\n      console.warn(`‚ö†Ô∏è Cet utilisateur a d√©j√† une √©cole associ√©e: ${existingSchools[0].name}`);\r\n      // On ne bloque plus ici, on continue la cr√©ation\r\n    }\r\n\r\n    // 3. G√©n√©rer un code unique pour l'√©cole\r\n    let schoolCode;\r\n    let isUnique = false;\r\n    let attempts = 0;\r\n    const maxAttempts = 10;\r\n    \r\n    while (!isUnique && attempts < maxAttempts) {\r\n      const prefix = schoolName.replace(/\\s+/g, '').substring(0, 3).toUpperCase();\r\n      const year = new Date().getFullYear();\r\n      const random = Math.floor(Math.random() * 999).toString().padStart(3, '0');\r\n      schoolCode = `${prefix}-${year}-${random}`;\r\n      \r\n      console.log(`üîç Tentative ${attempts + 1}: V√©rification unicit√© du code ${schoolCode}`);\r\n      \r\n      try {\r\n        const { data: existing, error: existingError } = await supabase\r\n          .from('schools')\r\n          .select('id')\r\n          .eq('code', schoolCode)\r\n          .maybeSingle();\r\n        \r\n        if (existingError) {\r\n          console.warn('‚ö†Ô∏è Erreur v√©rification code √©cole:', existingError);\r\n          if (existingError.code === '406' || existingError.status === 406) {\r\n            console.log('üí° Erreur 406 d√©tect√©e, on continue avec un autre code...');\r\n            isUnique = false;\r\n          } else {\r\n            // Pour les autres erreurs, on assume que le code est unique\r\n            isUnique = true;\r\n          }\r\n        } else {\r\n          isUnique = !existing;\r\n          console.log(`‚úÖ Code ${schoolCode} ${isUnique ? 'disponible' : 'd√©j√† utilis√©'}`);\r\n        }\r\n      } catch (error) {\r\n        console.warn('‚ö†Ô∏è Exception lors de la v√©rification:', error);\r\n        // En cas d'exception, on assume que le code est unique\r\n        isUnique = true;\r\n      }\r\n      \r\n      attempts++;\r\n    }\r\n\r\n    if (!isUnique) {\r\n      // G√©n√©rer un code de secours bas√© sur timestamp pour √©viter les conflits\r\n      const timestamp = Date.now().toString().slice(-4);\r\n      const prefix = schoolName.replace(/\\s+/g, '').substring(0, 3).toUpperCase();\r\n      schoolCode = `${prefix}-${new Date().getFullYear()}-${timestamp}`;\r\n      console.log('üîÑ Code de secours g√©n√©r√©:', schoolCode);\r\n    }\r\n\r\n    console.log('üî¢ Code √©cole final:', schoolCode);\r\n\r\n    // 4. Cr√©er l'utilisateur dans la table users avec toutes les donn√©es par d√©faut\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .upsert({\r\n        id: authUserId,\r\n        email: email,\r\n        full_name: directorName,\r\n        phone: phone || '', // Valeur par d√©faut pour √©viter les erreurs\r\n        role: 'principal',\r\n        is_active: true,\r\n        photo: '/assets/images/no_image.png', // Photo par d√©faut\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (userError) {\r\n      console.error('‚ùå Erreur cr√©ation utilisateur:', userError);\r\n      throw new Error(`Erreur lors de la cr√©ation de l'utilisateur: ${userError.message}`);\r\n    }\r\n\r\n    console.log('‚úÖ Utilisateur cr√©√©/mis √† jour:', userData.id);\r\n\r\n    // 5. Cr√©er l'√©cole\r\n    let { data: schoolData, error: schoolError } = await supabase\r\n      .from('schools')\r\n      .insert({\r\n        name: schoolName,\r\n        code: schoolCode,\r\n        type: schoolType,\r\n        director_name: directorName,\r\n        phone: phone,\r\n        address: address,\r\n        city: city,\r\n        country: country,\r\n        available_classes: availableClasses,\r\n        status: 'active',\r\n        director_user_id: authUserId,\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (schoolError) {\r\n      console.error('‚ùå Erreur cr√©ation √©cole:', schoolError);\r\n      // Si l'√©cole existe d√©j√†, essayer de la r√©cup√©rer\r\n      if (schoolError.code === '23505') { // Violation de contrainte unique\r\n        console.log('üîÑ Tentative de r√©cup√©ration de l\\'√©cole existante...');\r\n        const { data: existingSchool, error: fetchError } = await supabase\r\n          .from('schools')\r\n          .select('*')\r\n          .eq('director_user_id', authUserId)\r\n          .single();\r\n        \r\n        if (fetchError) {\r\n          throw new Error(`Erreur lors de la r√©cup√©ration de l'√©cole existante: ${fetchError.message}`);\r\n        }\r\n        \r\n        schoolData = existingSchool;\r\n        console.log('‚úÖ √âcole r√©cup√©r√©e:', schoolData.id);\r\n      } else {\r\n        throw new Error(`Erreur lors de la cr√©ation de l'√©cole: ${schoolError.message}`);\r\n      }\r\n    } else {\r\n      console.log('‚úÖ √âcole cr√©√©e:', schoolData.id);\r\n    }\r\n\r\n    // 6. Mettre √† jour l'utilisateur avec l'ID de l'√©cole\r\n    const { error: updateUserError } = await supabase\r\n      .from('users')\r\n      .update({\r\n        current_school_id: schoolData.id,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('id', authUserId);\r\n\r\n    if (updateUserError) {\r\n      console.warn('‚ö†Ô∏è Impossible de lier l\\'√©cole √† l\\'utilisateur:', updateUserError.message);\r\n    }\r\n\r\n    // 7. Cr√©er l'ann√©e acad√©mique par d√©faut\r\n    const currentYear = getCurrentAcademicYear();\r\n    const { startDate, endDate } = getAcademicYearDates(currentYear);\r\n    \r\n    const { data: academicYearData, error: academicYearError } = await supabase\r\n      .from('academic_years')\r\n      .insert({\r\n        school_id: schoolData.id,\r\n        name: currentYear,\r\n        start_date: startDate.toISOString().split('T')[0], // Format YYYY-MM-DD\r\n        end_date: endDate.toISOString().split('T')[0],\r\n        is_current: true,\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (academicYearError) {\r\n      console.warn('‚ö†Ô∏è Impossible de cr√©er l\\'ann√©e acad√©mique:', academicYearError.message);\r\n    } else {\r\n      console.log('‚úÖ Ann√©e acad√©mique cr√©√©e:', currentYear, '-', academicYearData.id);\r\n    }\r\n\r\n    // 8. Initialiser toutes les donn√©es par d√©faut de l'√©cole\r\n    let initializationResult = null;\r\n    let configurationResult = null;\r\n    \r\n    if (academicYearData) {\r\n      console.log('üèóÔ∏è Initialisation des donn√©es par d√©faut...');\r\n      initializationResult = await databaseService.initializeSchoolDefaults(schoolData.id, academicYearData.id);\r\n      \r\n      if (initializationResult.success) {\r\n        console.log('‚úÖ Donn√©es par d√©faut initialis√©es:', initializationResult.created);\r\n      } else {\r\n        console.warn('‚ö†Ô∏è Erreurs lors de l\\'initialisation:', initializationResult.errors);\r\n      }\r\n\r\n      // 8.1 Initialiser les configurations par d√©faut (types de notes, pr√©sence, r√¥les)\r\n      console.log('‚öôÔ∏è Initialisation des configurations par d√©faut...');\r\n      try {\r\n        configurationResult = await ConfigurationService.initializeSchoolConfigurations(schoolData.id);\r\n        \r\n        if (configurationResult.errors.length === 0) {\r\n          console.log('‚úÖ Configurations initialis√©es:', {\r\n            gradeTypes: configurationResult.gradeTypes.length,\r\n            attendanceTypes: configurationResult.attendanceTypes.length,\r\n            userRoles: configurationResult.userRoles.length\r\n          });\r\n        } else {\r\n          console.warn('‚ö†Ô∏è Certaines configurations ont √©chou√©:', configurationResult.errors);\r\n        }\r\n\r\n        // 8.2 Initialiser les p√©riodes d'√©valuation\r\n        try {\r\n          const evaluationPeriods = await ConfigurationService.initializeEvaluationPeriods(\r\n            schoolData.id, \r\n            academicYearData.id, \r\n            schoolType\r\n          );\r\n          configurationResult.evaluationPeriods = evaluationPeriods;\r\n          console.log(`‚úÖ ${evaluationPeriods.length} p√©riodes d'√©valuation cr√©√©es`);\r\n        } catch (periodError) {\r\n          console.warn('‚ö†Ô∏è Erreur lors de la cr√©ation des p√©riodes d\\'√©valuation:', periodError.message);\r\n          configurationResult.errors.push({ type: 'evaluationPeriods', error: periodError.message });\r\n        }\r\n\r\n      } catch (configError) {\r\n        console.warn('‚ö†Ô∏è Erreur lors de l\\'initialisation des configurations:', configError.message);\r\n        configurationResult = { \r\n          gradeTypes: [], \r\n          attendanceTypes: [], \r\n          userRoles: [], \r\n          evaluationPeriods: [],\r\n          errors: [{ type: 'general', error: configError.message }] \r\n        };\r\n      }\r\n    }\r\n\r\n    // 9. Retourner le r√©sultat\r\n    const result = {\r\n      school: schoolData,\r\n      user: userData,\r\n      academicYear: academicYearData,\r\n      initialization: initializationResult,\r\n      configuration: configurationResult\r\n    };\r\n\r\n    console.log('üéâ Service termin√© avec succ√®s !', result);\r\n\r\n    return {\r\n      success: true,\r\n      message: '√âcole cr√©√©e et li√©e avec succ√®s',\r\n      data: result\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Erreur dans createPrincipalSchool:', error);\r\n    return {\r\n      success: false,\r\n      message: error.message || 'Erreur lors de la cr√©ation de l\\'√©cole',\r\n      data: null\r\n    };\r\n  }\r\n};\r\n\r\n/**\r\n * Service pour r√©cup√©rer les informations d'une √©cole\r\n */\r\nexport const getSchoolByDirector = async (userId) => {\r\n  try {\r\n    const { data: school, error } = await supabase\r\n      .from('schools')\r\n      .select(`\r\n        *,\r\n        director:users!director_user_id(*),\r\n        academic_years!inner(*),\r\n        classes(*),\r\n        students(*),\r\n        teachers(*)\r\n      `)\r\n      .eq('director_user_id', userId)\r\n      .eq('academic_years.is_current', true)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Erreur r√©cup√©ration √©cole:', error);\r\n      return null;\r\n    }\r\n\r\n    return school;\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r√©cup√©ration de l\\'√©cole:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Service pour mettre √† jour les informations d'une √©cole\r\n */\r\nexport const updateSchool = async (schoolId, updateData) => {\r\n  try {\r\n    const { data: school, error } = await supabase\r\n      .from('schools')\r\n      .update({\r\n        ...updateData,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('id', schoolId)\r\n      .select(`\r\n        *,\r\n        director:users!director_user_id(*),\r\n        academic_years(*)\r\n      `)\r\n      .single();\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    return school;\r\n  } catch (error) {\r\n    console.error('Erreur lors de la mise √† jour de l\\'√©cole:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Service pour r√©cup√©rer les statistiques d'une √©cole\r\n */\r\nexport const getSchoolStats = async (schoolId) => {\r\n  try {\r\n    const [\r\n      { count: studentsCount },\r\n      { count: teachersCount },\r\n      { count: classesCount },\r\n      { count: paymentsCount }\r\n    ] = await Promise.all([\r\n      supabase.from('students').select('*', { count: 'exact' }).eq('school_id', schoolId).eq('is_active', true),\r\n      supabase.from('teachers').select('*', { count: 'exact' }).eq('school_id', schoolId).eq('is_active', true),\r\n      supabase.from('classes').select('*', { count: 'exact' }).eq('school_id', schoolId),\r\n      supabase.from('payments').select('*', { count: 'exact' }).eq('school_id', schoolId).eq('status', 'completed')\r\n    ]);\r\n\r\n    return {\r\n      students: studentsCount || 0,\r\n      teachers: teachersCount || 0,\r\n      classes: classesCount || 0,\r\n      payments: paymentsCount || 0\r\n    };\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r√©cup√©ration des statistiques:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport default {\r\n  createPrincipalSchool,\r\n  getSchoolByDirector,\r\n  updateSchool,\r\n  getSchoolStats\r\n};"],"names":["ConfigurationService","schoolId","results","defaultGradeTypes","gradeTypesData","gradeTypesError","supabase","defaultAttendanceTypes","attendanceTypesData","attendanceTypesError","defaultUserRoles","userRolesData","userRolesError","error","academicYearId","schoolType","periods","basePeriods","periodsToInsert","period","data","createPrincipalSchool","directorName","email","phone","schoolName","address","city","country","availableClasses","userId","authUserId","currentUser","currentUserError","existingSchools","checkError","err","schoolCode","isUnique","attempts","maxAttempts","prefix","year","random","existing","existingError","timestamp","userData","userError","schoolData","schoolError","existingSchool","fetchError","updateUserError","currentYear","getCurrentAcademicYear","startDate","endDate","getAcademicYearDates","academicYearData","academicYearError","initializationResult","configurationResult","databaseService","evaluationPeriods","periodError","configError","result"],"mappings":"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"}