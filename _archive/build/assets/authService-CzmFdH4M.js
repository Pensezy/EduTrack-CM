import{s}from"./index-Dxp_I30j.js";const v=async(h,g)=>{var l,d;try{const{data:r,error:a}=await s.auth.signInWithPassword({email:h,password:g});if(a){console.error("Erreur d'authentification Supabase:",a);let o=a.message;switch(a.message){case"Invalid login credentials":o="Email ou mot de passe incorrect";break;case"Email not confirmed":o="Votre email n'a pas encore √©t√© confirm√©. V√©rifiez votre bo√Æte mail.";break;case"Too many requests":o="Trop de tentatives de connexion. Veuillez patienter quelques minutes.";break;case"User not found":o="Aucun compte trouv√© avec cette adresse email";break;default:(l=a.message)!=null&&l.includes("invalid credentials")?o="Email ou mot de passe incorrect":(d=a.message)!=null&&d.includes("network")&&(o="Probl√®me de connexion internet. V√©rifiez votre connexion.")}throw new Error(o)}if(!r.user)throw new Error("Erreur d'authentification - aucun utilisateur retourn√©");console.log("‚úÖ Connexion r√©ussie pour:",r.user.email);const{error:m}=await s.from("users").update({last_login:new Date().toISOString(),login_attempts:0,updated_at:new Date().toISOString()}).eq("id",r.user.id);m?console.warn("‚ö†Ô∏è Erreur mise √† jour last_login:",m):console.log("‚úÖ Date de derni√®re connexion mise √† jour"),console.log("üîç Recherche √©cole pour utilisateur:",{userId:r.user.id,userEmail:r.user.email,metadata:r.user.user_metadata});const{data:e,error:i}=await s.from("schools").select(`
        id,
        name,
        code,
        type,
        director_name,
        phone,
        email,
        address,
        city,
        country,
        website,
        logo,
        description,
        available_classes,
        settings,
        status,
        director_user_id,
        created_at,
        updated_at
      `).eq("director_user_id",r.user.id).single();if(console.log("üè´ R√©sultat requ√™te √©cole:",{schoolData:e,schoolError:i,userId:r.user.id}),i){console.error("‚ùå Erreur lors de la recherche √©cole:",i);const{data:o,error:f}=await s.from("schools").select("id, name, director_user_id, director_name, status");if(console.log("üîç DEBUG - Toutes les √©coles dans la base:",o),console.log("üîç DEBUG - Erreur de la requ√™te debug:",f),console.log("üîç DEBUG - ID utilisateur recherch√©:",r.user.id),i.code==="PGRST116"&&o&&o.length>0){console.log("üîÑ Tentative de r√©cup√©ration via current_school_id...");const{data:c,error:w}=await s.from("users").select("current_school_id, full_name, email").eq("id",r.user.id).single();if(console.log("üë§ Donn√©es utilisateur:",c,w),c!=null&&c.current_school_id){const{data:n,error:_}=await s.from("schools").select(`
              id,
              name,
              code,
              type,
              director_name,
              phone,
              email,
              address,
              city,
              country,
              website,
              logo,
              description,
              available_classes,
              settings,
              status,
              director_user_id,
              created_at,
              updated_at
            `).eq("id",c.current_school_id).single();if(console.log("üè´ √âcole trouv√©e via current_school_id:",n,_),n&&!_){if(!n.director_user_id||n.director_user_id!==r.user.id){console.warn("‚ö†Ô∏è director_user_id incorrect ou manquant, correction en cours...");const{error:p}=await s.from("schools").update({director_user_id:r.user.id}).eq("id",c.current_school_id);p?console.error("‚ùå Erreur correction director_user_id:",p):(console.log("‚úÖ director_user_id corrig√© avec succ√®s"),n.director_user_id=r.user.id)}return{success:!0,user:r.user,school:n}}}}throw i.code==="PGRST116"?new Error("Aucune √©cole associ√©e √† ce compte. V√©rifiez que votre compte a bien √©t√© cr√©√© comme directeur d'√©tablissement."):new Error(`Erreur de r√©cup√©ration des donn√©es: ${i.message}`)}if(!e)throw new Error("Aucune √©cole trouv√©e pour ce compte");if(e.status==="pending")throw new Error("Votre compte est en attente de validation par l'administrateur");if(e.status==="suspended")throw new Error("Votre compte a √©t√© suspendu. Contactez l'administrateur.");if(e.status!=="active")throw new Error(`Statut du compte: ${e.status}. Contactez l'administrateur.`);const{data:t,error:u}=await s.from("users").select(`
        id,
        email,
        full_name,
        phone,
        role,
        current_school_id,
        is_active,
        created_at,
        updated_at
      `).eq("id",r.user.id).single();return u&&u.code!=="PGRST116"&&console.warn("Utilisateur non trouv√© dans la table users:",u.message),{success:!0,user:r.user,school:{id:e.id,name:e.name,code:e.code,type:e.type,directorName:e.director_name,phone:e.phone,email:e.email,address:e.address,city:e.city,country:e.country,website:e.website,logo:e.logo,description:e.description,availableClasses:e.available_classes,settings:e.settings,status:e.status,directorUserId:e.director_user_id,createdAt:e.created_at,updatedAt:e.updated_at},profile:t?{id:t.id,email:t.email,fullName:t.full_name,phone:t.phone,role:t.role,currentSchoolId:t.current_school_id,isActive:t.is_active,createdAt:t.created_at,updatedAt:t.updated_at}:null}}catch(r){return{success:!1,error:r.message||"Erreur lors de la connexion",user:null,school:null,profile:null}}};export{v as loginDirector};
//# sourceMappingURL=authService-CzmFdH4M.js.map
