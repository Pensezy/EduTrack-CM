import{s,g as M,a as z,d as F}from"./index-Dxp_I30j.js";class ${static async initializeSchoolConfigurations(r){console.log("‚öôÔ∏è Initialisation des configurations pour l'√©cole: "+r);const t={gradeTypes:[],attendanceTypes:[],userRoles:[],errors:[]};try{const o=[{school_id:r,name:"Devoir Surveill√©",code:"DS",coefficient:1,description:"√âvaluation formelle en classe"},{school_id:r,name:"Devoir Maison",code:"DM",coefficient:.5,description:"Travail √† faire √† la maison"},{school_id:r,name:"Contr√¥le Continu",code:"CC",coefficient:1,description:"√âvaluation continue"},{school_id:r,name:"Examen Final",code:"EF",coefficient:2,description:"Examen de fin de p√©riode"},{school_id:r,name:"Projet",code:"PROJ",coefficient:1.5,description:"Travail de projet"}],{data:i,error:l}=await s.from("grade_types").insert(o).select();l?(console.warn("‚ö†Ô∏è Erreur cr√©ation types de notes:",l),t.errors.push({type:"gradeTypes",error:l.message})):(t.gradeTypes=i,console.log("‚úÖ Types de notes cr√©√©s:",i.length));const _=[{school_id:r,name:"Pr√©sent",code:"PRESENT",description:"√âl√®ve pr√©sent en cours"},{school_id:r,name:"Absent",code:"ABSENT",description:"√âl√®ve absent non justifi√©"},{school_id:r,name:"Retard",code:"LATE",description:"√âl√®ve en retard"},{school_id:r,name:"Justifi√©",code:"JUSTIFIED",description:"Absence justifi√©e"},{school_id:r,name:"Exempt√©",code:"EXEMPT",description:"√âl√®ve exempt√© de cours"}],{data:p,error:d}=await s.from("attendance_types").insert(_).select();d?(console.warn("‚ö†Ô∏è Erreur cr√©ation types de pr√©sence:",d),t.errors.push({type:"attendanceTypes",error:d.message})):(t.attendanceTypes=p,console.log("‚úÖ Types de pr√©sence cr√©√©s:",p.length));const f=[{school_id:r,name:"Enseignant",code:"TEACHER",permissions:["view_grades","view_students","manage_attendance"]},{school_id:r,name:"Secr√©taire",code:"SECRETARY",permissions:["manage_students","manage_payments","manage_documents"]},{school_id:r,name:"Surveillant",code:"MONITOR",permissions:["view_students","manage_attendance"]},{school_id:r,name:"Coordinateur",code:"COORDINATOR",permissions:["manage_teachers","view_analytics","manage_classes"]}],{data:a,error:g}=await s.from("user_roles").insert(f).select();return g?(console.warn("‚ö†Ô∏è Erreur cr√©ation r√¥les utilisateur:",g),t.errors.push({type:"userRoles",error:g.message})):(t.userRoles=a,console.log("‚úÖ R√¥les utilisateur cr√©√©s:",a.length)),t.success=t.errors.length===0,t}catch(o){return console.error("‚ùå Erreur lors de l'initialisation des configurations:",o),t.errors.push({type:"general",error:o.message}),t.success=!1,t}}static async getDefaultConfigurations(){return{gradeTypes:[{name:"Devoir Surveill√©",code:"DS",coefficient:1},{name:"Devoir Maison",code:"DM",coefficient:.5},{name:"Contr√¥le Continu",code:"CC",coefficient:1},{name:"Examen Final",code:"EF",coefficient:2}],attendanceTypes:[{name:"Pr√©sent",code:"PRESENT"},{name:"Absent",code:"ABSENT"},{name:"Retard",code:"LATE"},{name:"Justifi√©",code:"JUSTIFIED"}],userRoles:[{name:"Enseignant",code:"TEACHER"},{name:"Secr√©taire",code:"SECRETARY"},{name:"Surveillant",code:"MONITOR"}]}}static async initializeEvaluationPeriods(r,t,o){console.log("üìÖ Initialisation des p√©riodes d'√©valuation pour:",o);let i=[];const l=[{name:"Premier Trimestre",start_date:"2024-09-01",end_date:"2024-11-30"},{name:"Deuxi√®me Trimestre",start_date:"2024-12-01",end_date:"2025-03-31"},{name:"Troisi√®me Trimestre",start_date:"2025-04-01",end_date:"2025-07-31"}];o.includes("lyc√©e")||o.includes("college")||o.includes("secondaire")||o.includes("primaire"),i=l;const _=i.map(f=>({...f,school_id:r,academic_year_id:t,is_current:f.name==="Premier Trimestre"})),{data:p,error:d}=await s.from("evaluation_periods").insert(_).select();if(d)throw console.warn("‚ö†Ô∏è Erreur cr√©ation p√©riodes d'√©valuation:",d),d;return console.log("‚úÖ P√©riodes d'√©valuation cr√©√©es:",p.length),p}}const J=async({directorName:S,email:r,phone:t,schoolName:o,schoolType:i,address:l,city:_="Yaound√©",country:p="Cameroun",availableClasses:d=[],userId:f=null})=>{try{console.log("üè´ Service createPrincipalSchool appel√© avec:",{directorName:S,email:r,schoolName:o,schoolType:i,userId:f});let a=f;if(!a){const{data:e,error:n}=await s.auth.getUser();if(n||!(e!=null&&e.user))throw new Error("Aucun utilisateur connect√©. Veuillez vous reconnecter.");a=e.user.id}console.log("üë§ Utilisation de l'ID utilisateur:",a);let g=[],x=null;try{const{data:e,error:n}=await s.from("schools").select("id, name").eq("director_user_id",a);n?(console.warn("‚ö†Ô∏è Erreur v√©rification √©cole existante (non bloquante):",n),x=n):g=e}catch(e){console.warn("‚ö†Ô∏è Exception lors de la v√©rification √©cole existante (non bloquante):",e),x=e}g&&g.length>0&&console.warn(`‚ö†Ô∏è Cet utilisateur a d√©j√† une √©cole associ√©e: ${g[0].name}`);let m,E=!1,T=0;const U=10;for(;!E&&T<U;){const e=o.replace(/\s+/g,"").substring(0,3).toUpperCase(),n=new Date().getFullYear(),q=Math.floor(Math.random()*999).toString().padStart(3,"0");m=`${e}-${n}-${q}`,console.log(`üîç Tentative ${T+1}: V√©rification unicit√© du code ${m}`);try{const{data:R,error:y}=await s.from("schools").select("id").eq("code",m).maybeSingle();y?(console.warn("‚ö†Ô∏è Erreur v√©rification code √©cole:",y),y.code==="406"||y.status===406?(console.log("üí° Erreur 406 d√©tect√©e, on continue avec un autre code..."),E=!1):E=!0):(E=!R,console.log(`‚úÖ Code ${m} ${E?"disponible":"d√©j√† utilis√©"}`))}catch(R){console.warn("‚ö†Ô∏è Exception lors de la v√©rification:",R),E=!0}T++}if(!E){const e=Date.now().toString().slice(-4);m=`${o.replace(/\s+/g,"").substring(0,3).toUpperCase()}-${new Date().getFullYear()}-${e}`,console.log("üîÑ Code de secours g√©n√©r√©:",m)}console.log("üî¢ Code √©cole final:",m);const{data:P,error:D}=await s.from("users").upsert({id:a,email:r,full_name:S,phone:t||"",role:"principal",is_active:!0,photo:"/assets/images/no_image.png",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(D)throw console.error("‚ùå Erreur cr√©ation utilisateur:",D),new Error(`Erreur lors de la cr√©ation de l'utilisateur: ${D.message}`);console.log("‚úÖ Utilisateur cr√©√©/mis √† jour:",P.id);let{data:u,error:h}=await s.from("schools").insert({name:o,code:m,type:i,director_name:S,phone:t,address:l,city:_,country:p,available_classes:d,status:"active",director_user_id:a,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(h)if(console.error("‚ùå Erreur cr√©ation √©cole:",h),h.code==="23505"){console.log("üîÑ Tentative de r√©cup√©ration de l'√©cole existante...");const{data:e,error:n}=await s.from("schools").select("*").eq("director_user_id",a).single();if(n)throw new Error(`Erreur lors de la r√©cup√©ration de l'√©cole existante: ${n.message}`);u=e,console.log("‚úÖ √âcole r√©cup√©r√©e:",u.id)}else throw new Error(`Erreur lors de la cr√©ation de l'√©cole: ${h.message}`);else console.log("‚úÖ √âcole cr√©√©e:",u.id);const{error:A}=await s.from("users").update({current_school_id:u.id,updated_at:new Date().toISOString()}).eq("id",a);A&&console.warn("‚ö†Ô∏è Impossible de lier l'√©cole √† l'utilisateur:",A.message);const C=M(),{startDate:Y,endDate:I}=z(C),{data:w,error:O}=await s.from("academic_years").insert({school_id:u.id,name:C,start_date:Y.toISOString().split("T")[0],end_date:I.toISOString().split("T")[0],is_current:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();O?console.warn("‚ö†Ô∏è Impossible de cr√©er l'ann√©e acad√©mique:",O.message):console.log("‚úÖ Ann√©e acad√©mique cr√©√©e:",C,"-",w.id);let v=null,c=null;if(w){console.log("üèóÔ∏è Initialisation des donn√©es par d√©faut..."),v=await F.initializeSchoolDefaults(u.id,w.id),v.success?console.log("‚úÖ Donn√©es par d√©faut initialis√©es:",v.created):console.warn("‚ö†Ô∏è Erreurs lors de l'initialisation:",v.errors),console.log("‚öôÔ∏è Initialisation des configurations par d√©faut...");try{c=await $.initializeSchoolConfigurations(u.id),c.errors.length===0?console.log("‚úÖ Configurations initialis√©es:",{gradeTypes:c.gradeTypes.length,attendanceTypes:c.attendanceTypes.length,userRoles:c.userRoles.length}):console.warn("‚ö†Ô∏è Certaines configurations ont √©chou√©:",c.errors);try{const e=await $.initializeEvaluationPeriods(u.id,w.id,i);c.evaluationPeriods=e,console.log(`‚úÖ ${e.length} p√©riodes d'√©valuation cr√©√©es`)}catch(e){console.warn("‚ö†Ô∏è Erreur lors de la cr√©ation des p√©riodes d'√©valuation:",e.message),c.errors.push({type:"evaluationPeriods",error:e.message})}}catch(e){console.warn("‚ö†Ô∏è Erreur lors de l'initialisation des configurations:",e.message),c={gradeTypes:[],attendanceTypes:[],userRoles:[],evaluationPeriods:[],errors:[{type:"general",error:e.message}]}}}const b={school:u,user:P,academicYear:w,initialization:v,configuration:c};return console.log("üéâ Service termin√© avec succ√®s !",b),{success:!0,message:"√âcole cr√©√©e et li√©e avec succ√®s",data:b}}catch(a){return console.error("‚ùå Erreur dans createPrincipalSchool:",a),{success:!1,message:a.message||"Erreur lors de la cr√©ation de l'√©cole",data:null}}};export{J as createPrincipalSchool};
//# sourceMappingURL=schoolService-B_ZAdpzo.js.map
